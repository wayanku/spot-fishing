








<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SpotStrike by Wayan & StoryBali</title>
    <meta name="theme-color" content="#000000">
    
    <!-- PWA Manifest & Icons -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SpotStrike">
    <meta name="application-name" content="SpotStrike">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2970/2970068.png">
    <link rel="icon" type="image/png" href="https://cdn-icons-png.flaticon.com/512/2970/2970068.png">
    <!-- Manifest ditanam langsung (Tanpa file baru) -->
    <link rel="manifest" href="./manifest.json">

    <!-- CSS & Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>
    <!-- Solunar/Sun/Moon Calculator -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/suncalc/1.8.0/suncalc.min.js"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Shrikhand&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css">
    <style>
        /* Styles untuk Sistem Halaman (View System) */
        .view-section {
            display: none;
            height: 100dvh;
            width: 100%;
            overflow-y: auto;
            padding-bottom: 60px !important; /* Perubahan: Jarak konten ke navigasi dikurangi agar mepet */
            position: fixed;
            top: 0;
            left: 0;
            z-index: 50;
            background: #000000;
        }
        .view-section.active {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        /* Map View specific */
        #view-map {
            overflow: hidden;
            z-index: 1; /* Map layer paling bawah saat aktif */
        }
        /* View Specific Backgrounds */
        #view-home, #view-settings {
            background: #000000;
        }
        #view-profile { background: #000000; }
        #view-weather {
            background: transparent; /* Transparent to show canvas */
        }
        #view-reels {
            background: #000000;
            padding-bottom: 0 !important; /* Full screen for reels */
        }
        
        /* Hide Scrollbar for Chrome/Safari/Webkit */
        .view-section::-webkit-scrollbar { display: none; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="overflow-hidden">

    <!-- LOGIN / REGISTER OVERLAY -->
    <canvas id="weather-canvas" class="fixed inset-0 z-[9990] pointer-events-none"></canvas>

    <div id="auth-overlay" class="fixed inset-0 z-[10000] flex items-center justify-center p-6 hidden bg-black/90 backdrop-blur-sm">
        <div class="glass w-full max-w-md p-8 md:p-10 rounded-[2.5rem] shadow-2xl border border-white/10 m-4 relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gradient-to-r from-blue-500 via-purple-500 to-pink-500"></div>
            <!-- Language Selector (Auth) -->
            <div class="absolute top-6 right-6">
                <select onchange="changeLanguage(this.value)" class="bg-neutral-800/50 text-white text-xs p-1.5 rounded-lg border border-white/10 outline-none">
                    <option value="id">üáÆüá© ID</option><option value="en">üá∫üá∏ EN</option><option value="jp">üáØüáµ JP</option>
                </select>
            </div>
            <!-- Close Button (Hidden by default, shown when opened from profile) -->
            <button id="auth-close-btn" onclick="closeAuthOverlay()" class="absolute top-6 left-6 text-slate-400 hover:text-white hidden transition-colors"><i data-lucide="x" class="w-6 h-6"></i></button>

            <div class="text-center mb-8">
                <div class="bg-gradient-to-br from-blue-500 to-blue-700 w-20 h-20 rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-xl shadow-blue-500/20 ring-4 ring-blue-500/10">
                    <i data-lucide="anchor" class="text-white w-8 h-8"></i>
                </div>
                <h2 class="text-3xl font-black tracking-tight text-gradient mb-2" data-i18n="app_title">SpotStrike</h2>
                <p class="text-xs font-bold text-slate-500 uppercase tracking-widest">by Wayan & StoryBali</p>
                <p class="text-slate-400 text-sm" data-i18n="login_subtitle">Masuk untuk simpan spot memancing Anda</p>
            </div>
            
            <div class="space-y-4">
                <button onclick="handleAuth('google')" class="w-full bg-white text-slate-900 py-4 rounded-2xl font-bold transition-all shadow-lg hover:bg-slate-100 active:scale-95 flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
                    Masuk dengan Google
                </button>
            </div>
            <p id="auth-error" class="text-red-400 text-xs mt-4 text-center hidden"></p>
        </div>
    </div>

    <!-- MAIN APP CONTENT (Hidden until login) -->
    <div id="app-content" class="">

        <!-- === HALAMAN 1: HOME (FEED) === -->
        <div id="view-home" class="view-section active">
            <!-- Header (Relative - Ikut Scroll) -->
            <div id="home-header" class="relative z-50 bg-black/90 backdrop-blur-md header-safe pb-2 px-2 md:px-6 border-b border-white/5 transition-all duration-300">
                <div class="flex items-center justify-between">
                    <!-- Left: Add Button -->
                    <button onclick="openAddModal()" class="p-2 text-slate-200 hover:text-white transition-colors">
                        <i data-lucide="plus" class="w-7 h-7"></i>
                    </button>
                    <!-- Center: Title (Calligraphy) -->
                    <h1 class="text-3xl md:text-4xl text-center flex-1 text-white" style="font-family: 'Shrikhand', cursive; letter-spacing: 1px; filter: drop-shadow(0 2px 10px rgba(59,130,246,0.5));">SpotStrike</h1>
                    <!-- Right: Favorites (Love) -->
                    <button onclick="openFavorites()" class="p-2 text-slate-200 hover:text-red-500 transition-colors">
                        <i data-lucide="heart" class="w-7 h-7"></i>
                    </button>
                </div>
            </div>

            <!-- Pull to Refresh Spinner (Behind Content) -->
            <div id="ptr-spinner" class="absolute left-1/2 -translate-x-1/2 z-0 w-full flex justify-center pt-6" style="top: calc(80px + env(safe-area-inset-top));">
                <div id="ptr-icon" class="bg-white text-black p-2 rounded-full shadow-xl border border-black/10 scale-0 transition-transform duration-200">
                    <i data-lucide="loader" class="w-5 h-5 animate-spin"></i>
                </div>
            </div>

            <!-- Content Wrapper (Scrollable & Pullable) -->
            <div id="home-content-wrapper" class="relative z-10 bg-black pb-24 min-h-[calc(100vh-80px)] transition-transform duration-300 ease-out">
                <div class="pt-4">
                <!-- Stories / Highlights -->
                <div id="ai-stories-container" class="flex gap-4 overflow-x-auto no-scrollbar mb-2 pb-2 px-4 md:px-6">
                    <!-- Skeleton Loading Story -->
                    <div class="flex flex-col items-center gap-1 shrink-0 animate-pulse">
                        <div class="w-[4.5rem] h-[4.5rem] rounded-full bg-slate-800 border-2 border-slate-900"></div>
                        <div class="h-2 w-12 bg-slate-800 rounded"></div>
                    </div>
                    <div class="flex flex-col items-center gap-1 shrink-0 animate-pulse">
                        <div class="w-[4.5rem] h-[4.5rem] rounded-full bg-slate-800 border-2 border-slate-900"></div>
                        <div class="h-2 w-12 bg-slate-800 rounded"></div>
                    </div>
                    <div class="flex flex-col items-center gap-1 shrink-0 animate-pulse">
                        <div class="w-[4.5rem] h-[4.5rem] rounded-full bg-slate-800 border-2 border-slate-900"></div>
                        <div class="h-2 w-12 bg-slate-800 rounded"></div>
                    </div>
                    <div class="flex flex-col items-center gap-1 shrink-0 animate-pulse">
                        <div class="w-[4.5rem] h-[4.5rem] rounded-full bg-slate-800 border-2 border-slate-900"></div>
                        <div class="h-2 w-12 bg-slate-800 rounded"></div>
                    </div>
                    <div class="flex flex-col items-center gap-1 shrink-0 animate-pulse">
                        <div class="w-[4.5rem] h-[4.5rem] rounded-full bg-slate-800 border-2 border-slate-900"></div>
                        <div class="h-2 w-12 bg-slate-800 rounded"></div>
                    </div>
                </div>

                <!-- Feed -->
                <div id="home-feed-container" class="space-y-0">
                    <!-- Skeleton Feed (Struktur Loading) -->
                    <div class="mb-4 border-b border-white/5 pb-4 animate-pulse">
                        <div class="flex items-center gap-3 px-4 py-3">
                            <div class="w-10 h-10 rounded-full bg-neutral-800"></div>
                            <div class="flex-1 space-y-2">
                                <div class="h-3 w-24 bg-neutral-800 rounded"></div>
                                <div class="h-2 w-16 bg-neutral-800 rounded"></div>
                            </div>
                        </div>
                        <div class="w-full aspect-[4/5] bg-neutral-800"></div>
                        <div class="px-4 pt-3 space-y-2">
                            <div class="h-3 w-20 bg-neutral-800 rounded"></div>
                            <div class="h-2 w-full bg-neutral-800 rounded"></div>
                            <div class="h-2 w-3/4 bg-neutral-800 rounded"></div>
                        </div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- === HALAMAN 2: PETA (MAP) === -->
        <div id="view-map" class="view-section">
            <!-- Search Bar (Moved inside Map View) -->
            <div class="absolute top-2 left-4 right-4 z-[1000] transition-all duration-300 pt-safe">
                <div class="glass rounded-full flex items-center p-2 max-w-lg mx-auto shadow-2xl border border-white/10 backdrop-blur-xl bg-neutral-900/60 ring-1 ring-white/5">
                    <button onclick="startVoiceSearch()" id="mic-btn" class="p-2 text-slate-400 hover:text-white transition-colors">
                    <i data-lucide="mic" class="w-4 h-4"></i>
                </button>
                <input type="text" id="search-input" data-i18n-placeholder="search_placeholder" placeholder="Cari lokasi (Desa, Kota, Laut)..." 
                       class="bg-transparent border-none text-sm text-white placeholder-slate-400 focus:outline-none w-full ml-3"
                       onkeypress="handleSearch(event)">
                <button onclick="searchLocation()" id="search-btn" class="p-2 bg-blue-600 rounded-full text-white hover:bg-blue-500 transition-colors shadow-lg shadow-blue-600/30" aria-label="Cari lokasi">
                    <i data-lucide="search" class="w-4 h-4"></i>
                </button>
            </div>
        </div>

        <div id="map"></div>

        <!-- Map Legends (For NASA Layers) -->
        <div id="map-legends" class="absolute bottom-24 md:bottom-8 left-4 z-[950] pointer-events-auto space-y-2">
            <div id="sst-legend" class="hidden glass p-2 rounded-lg w-48 shadow-lg animate-in fade-in duration-300">
                <p class="text-[9px] font-bold text-slate-300 mb-1 text-center">Suhu Laut (¬∞C)</p>
                <div class="w-full h-3 rounded-md border border-white/10" style="background: linear-gradient(to right, #9333ea, #3b82f6, #22c55e, #eab308, #ef4444);"></div>
            </div>
            <div id="chloro-legend" class="hidden glass p-2 rounded-lg w-48 shadow-lg animate-in fade-in duration-300">
                <p class="text-[10px] font-bold text-slate-300 mb-1 text-center">Klorofil-a (mg/m¬≥)</p>
                <div class="w-full h-3 rounded-md border border-white/10" style="background: linear-gradient(to right, #3b82f6, #22c55e, #eab308);"></div>
            </div>
        </div>
        
        <!-- Floating Buttons -->
        <button onclick="locateUser()" class="absolute bottom-28 right-4 md:bottom-32 md:right-8 z-[900] glass p-3 rounded-full text-blue-400 shadow-xl hover:scale-110 transition-transform active:scale-90 animate-float mb-safe"><i data-lucide="navigation" class="w-6 h-6"></i></button>
        <button onclick="findNearestSpot()" class="absolute bottom-44 right-4 md:bottom-48 md:right-8 z-[900] glass p-3 rounded-full text-emerald-400 shadow-xl hover:scale-110 transition-transform active:scale-90 animate-float-delay mb-safe"><i data-lucide="locate-fixed" class="w-6 h-6"></i></button>
        <button onclick="openMapSettings()" class="absolute bottom-60 right-4 md:bottom-64 md:right-8 z-[900] glass p-3 rounded-full text-yellow-400 shadow-xl hover:scale-110 transition-transform active:scale-90 animate-float mb-safe" aria-label="Layer Peta"><i data-lucide="layers" class="w-6 h-6"></i></button>
        </div>

        <!-- === HALAMAN 3: CUACA (WEATHER) === -->
        <div id="view-weather" class="view-section">
            <!-- Container ID 'location-panel' dipertahankan agar script.js tetap bisa mengisi data -->
            <div id="location-panel" class="p-6 pt-10 max-w-2xl mx-auto">
                <h2 class="text-2xl font-black text-white mb-6">Kondisi Cuaca</h2>
                
                <div class="flex items-start justify-between mb-6">
                    <div>
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i data-lucide="map-pin" class="text-blue-400 w-5 h-5"></i> <span id="panel-address">Mengambil lokasi...</span>
                        </h3>
                        <p id="panel-coords" class="text-xs text-slate-400 font-mono mt-1">-</p>
                    </div>
                </div>

                <!-- Weather Grid (Updated to 3x2 for more info) -->
                <!-- Mobile Optimization: Horizontal Scroll (Carousel) -->
                <div id="weather-scroll" class="flex overflow-x-auto gap-3 mb-3 pb-2 no-scrollbar snap-x" onscroll="updateScrollDots()">
                    <div onclick="showMetricInsight('score')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-blue-600 to-indigo-600 p-3 rounded-2xl shadow-lg shadow-blue-500/20 text-center relative overflow-hidden flex flex-col justify-center transform transition hover:scale-105 active:scale-95 border border-white/10 cursor-pointer">
                        <div class="absolute top-0 right-0 p-1"><i data-lucide="sparkles" class="w-3 h-3 text-yellow-400 animate-pulse"></i></div>
                        <p class="text-[10px] text-blue-100 uppercase font-bold mb-1" data-i18n="wx_score">AI Score</p>
                        <div class="text-2xl font-black text-white" id="wx-score">--%</div>
                    </div>
                    <div onclick="showMetricInsight('temp')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-orange-500/10 to-red-500/5 border border-orange-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_temp">Suhu</p>
                        <div class="text-2xl font-black text-white" id="wx-temp">--¬∞</div>
                    </div>
                    <div onclick="showMetricInsight('wind')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-cyan-500/10 to-blue-500/5 border border-cyan-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col items-center justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_wind">Angin</p>
                        <div class="flex items-center gap-1">
                            <i data-lucide="arrow-up" id="wx-wind-dir" class="w-4 h-4 text-blue-400 wind-arrow"></i>
                            <span class="text-xl font-bold text-white" id="wx-wind-speed">--</span>
                        </div>
                        <span class="text-[9px] text-slate-500">km/h</span>
                    </div>
                    <div onclick="showMetricInsight('weather')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-slate-700/30 to-slate-800/10 border border-white/5 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_weather">Cuaca</p>
                        <div class="text-sm font-bold text-blue-300 mt-1" id="wx-desc">Memuat...</div>
                    </div>
                    <div onclick="showMetricInsight('wave')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-teal-500/10 to-emerald-500/5 border border-teal-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_wave">Ombak (Max)</p>
                        <div class="text-xl font-black text-cyan-300 mt-1" id="wx-wave">-- m</div>
                    </div>
                    <div onclick="showMetricInsight('travel')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-green-500/10 to-emerald-500/5 border border-green-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_travel">Perjalanan</p>
                        <div class="text-sm font-black text-emerald-400 mt-1 leading-tight" id="panel-dist">-- km<br>-- mnt</div>
                    </div>
                    <div onclick="showMetricInsight('tide')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-purple-500/10 to-pink-500/5 border border-purple-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_tide">Pasang Surut</p>
                        <div class="text-xl font-black text-purple-300 mt-1" id="wx-tide">-- m</div>
                    </div>
                    <div onclick="showMetricInsight('depth')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-cyan-900/40 to-blue-900/20 border border-cyan-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_depth">Kedalaman</p>
                        <div class="text-xl font-black text-cyan-300 mt-1" id="wx-depth">-- m</div>
                    </div>
                    <div onclick="showMetricInsight('sst')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-indigo-500/10 to-blue-500/5 border border-indigo-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1">Suhu Air</p>
                        <div class="text-xl font-black text-indigo-300 mt-1" id="wx-sst">--¬∞C</div>
                    </div>
                    <div onclick="showMetricInsight('sun')" class="min-w-[100px] md:min-w-[130px] snap-center bg-gradient-to-br from-yellow-500/10 to-orange-500/5 border border-yellow-500/20 hover:bg-slate-800/60 transition-all p-3 rounded-2xl text-center flex flex-col justify-center backdrop-blur-sm hover:scale-105 active:scale-95 cursor-pointer">
                        <p class="text-[10px] text-slate-400 uppercase font-bold mb-1" data-i18n="wx_sun">Matahari</p>
                        <div class="text-[10px] font-bold text-yellow-300 mt-1 leading-tight" id="wx-sun">--:--<br>--:--</div>
                    </div>
                </div>
                
                <!-- Scroll Indicators (Dots) -->
                <div id="scroll-dots" class="flex justify-center gap-1.5 mb-6"></div>

                <!-- AI Insight Panel (New) -->
                <div id="weather-insight-panel" class="hidden mb-6 bg-neutral-900/50 p-4 rounded-2xl border border-blue-500/30 relative overflow-hidden animate-in fade-in slide-in-from-top-4 duration-300">
                    <div class="absolute top-0 right-0 p-2 opacity-10"><i data-lucide="bot" class="w-12 h-12 text-blue-400"></i></div>
                    <div class="flex items-start gap-3">
                        <div class="bg-blue-500/20 p-2 rounded-lg text-blue-400 shrink-0 mt-1">
                            <i id="insight-icon" data-lucide="info" class="w-5 h-5"></i>
                        </div>
                        <div>
                            <h4 id="insight-title" class="text-xs font-bold text-blue-300 uppercase mb-1">Analisis AI</h4>
                            <p id="insight-text" class="text-sm text-slate-200 leading-relaxed">...</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('weather-insight-panel').classList.add('hidden')" class="absolute top-2 right-2 text-slate-500 hover:text-white"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>

                <!-- 7-Day Forecast & Fishing Rating (New Feature) -->
                <div class="mb-6">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center gap-2"><i data-lucide="calendar-days" class="w-3 h-3"></i> <span data-i18n="forecast_title">Prakiraan 7 Hari & Potensi Mancing</span></h4>
                    <div id="forecast-list" class="space-y-2"></div>
                </div>

                <!-- Actions -->
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="openStreetViewFromPanel()" class="bg-neutral-800/80 hover:bg-neutral-700 border border-neutral-600 py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95">
                        <i data-lucide="eye" class="w-4 h-4"></i> Street View
                    </button>
                    <button onclick="openRouteModal()" class="bg-blue-600 hover:bg-blue-500 border border-blue-500 py-4 rounded-2xl font-bold text-sm flex items-center justify-center gap-2 transition-all active:scale-95 shadow-lg shadow-blue-900/50 text-white">
                        <i data-lucide="map" class="w-4 h-4"></i> Lihat Rute
                    </button>
                </div>
            </div>
        </div>
        
        <!-- === HALAMAN 5: REELS (New Feature) === -->
        <div id="view-reels" class="view-section">
            <div id="reels-container" class="h-full w-full overflow-y-scroll snap-y snap-mandatory no-scrollbar scroll-smooth">
                <!-- Video Reels akan dimuat di sini oleh script.js -->
            </div>
        </div>

        <!-- === HALAMAN 5: PROFILE (Instagram Style) === -->
        <div id="view-profile" class="view-section">
            <div class="pb-24">
                <!-- Header (Username & Settings) -->
                <div class="sticky top-0 z-30 bg-black/90 backdrop-blur-md border-b border-white/10 px-4 pb-3 flex items-center justify-between" style="padding-top: calc(2.5rem + env(safe-area-inset-top));">
                    <div class="flex items-center gap-1">
                        <i data-lucide="lock" class="w-3 h-3 text-slate-400"></i>
                        <h2 class="text-lg font-bold text-white" id="profile-username">@guest</h2>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-white"></i>
                    </div>
                    <div class="flex items-center gap-5">
                        <button onclick="openAddModal()"><i data-lucide="plus-square" class="w-6 h-6 text-white"></i></button>
                        <button onclick="navigateTo('settings')"><i data-lucide="menu" class="w-6 h-6 text-white"></i></button>
                    </div>
                </div>

                <!-- Profile Info -->
                <div class="px-4 pt-4 pb-2">
                    <div class="flex items-center justify-between mb-4">
                        <!-- Avatar -->
                        <div class="w-20 h-20 rounded-full p-[2px] bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 shrink-0 mr-4">
                            <div class="w-full h-full rounded-full border-2 border-black overflow-hidden bg-neutral-800">
                                <img id="profile-image" src="" class="w-full h-full object-cover">
                            </div>
                        </div>
                        
                        <!-- Stats -->
                        <div class="flex-1 flex justify-around text-center text-white">
                            <div>
                                <div class="font-bold text-lg" id="profile-posts-count">0</div>
                                <div class="text-xs text-slate-400">Postingan</div>
                            </div>
                            <div>
                                <div class="font-bold text-lg">1.2K</div>
                                <div class="text-xs text-slate-400">Pengikut</div>
                            </div>
                            <div>
                                <div class="font-bold text-lg">450</div>
                                <div class="text-xs text-slate-400">Mengikuti</div>
                            </div>
                        </div>
                    </div>

                    <!-- Bio -->
                    <div class="text-white text-sm mb-4">
                        <div class="font-bold" id="profile-name">Guest User</div>
                        <div class="text-slate-300 leading-snug mt-1" id="profile-bio">
                            üé£ Hobby Mancing & Petualang<br>
                            üìç Bali, Indonesia<br>
                            üåä Laut adalah rumah keduaku.
                        </div>
                    </div>

                    <!-- Buttons -->
                    <div class="flex gap-2 mb-6">
                        <button onclick="openEditProfile()" class="flex-1 bg-neutral-800 text-white text-xs font-bold py-2 rounded-lg hover:bg-neutral-700 transition-colors">Edit Profil</button>
                        <button class="flex-1 bg-neutral-800 text-white text-xs font-bold py-2 rounded-lg hover:bg-neutral-700 transition-colors">Bagikan Profil</button>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="flex border-t border-white/10">
                    <button class="flex-1 py-3 border-b-2 border-white flex justify-center"><i data-lucide="grid" class="w-6 h-6 text-white"></i></button>
                    <button class="flex-1 py-3 border-b-2 border-transparent flex justify-center"><i data-lucide="film" class="w-6 h-6 text-slate-500"></i></button>
                    <button class="flex-1 py-3 border-b-2 border-transparent flex justify-center"><i data-lucide="user-square" class="w-6 h-6 text-slate-500"></i></button>
                </div>

                <!-- Grid Posts -->
                <div id="profile-grid" class="grid grid-cols-3 gap-0.5 bg-black">
                    <!-- Content injected via JS -->
                </div>
            </div>
        </div>

        <!-- === HALAMAN 4: MENU / SETTINGS === -->
        <div id="view-settings" class="view-section">
            <div class="p-6 max-w-2xl mx-auto" style="padding-top: calc(2.5rem + env(safe-area-inset-top));">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-2xl font-black text-white">Menu & Pengaturan</h2>
                    <button onclick="navigateTo('profile')" class="p-2 bg-neutral-800 rounded-full text-slate-400 hover:text-white transition-colors border border-white/10">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
                <!-- Konten dipindahkan dari legendModal -->
                <div id="settings-content-placeholder"></div> 
                <!-- Script di bawah akan memindahkan konten asli ke sini -->
            </div>
        </div>

        <!-- Bottom Navigation Bar (Instagram Style) -->
        <div class="fixed bottom-0 left-0 right-0 md:bottom-6 md:w-[500px] md:left-1/2 md:-translate-x-1/2 z-[900] bg-black/90 backdrop-blur-xl md:rounded-3xl pt-2 px-0 pb-0 md:pb-4 md:px-8 grid grid-cols-5 justify-items-center items-center shadow-2xl transition-all duration-300 border-t md:border border-white/10">
            <button onclick="navigateTo('home')" class="nav-btn p-2 text-blue-400 flex flex-col items-center transition-colors group" id="nav-home">
                <i data-lucide="home" class="w-7 h-7 group-hover:scale-110 transition-transform"></i>
            </button>
            <button onclick="navigateTo('map')" class="nav-btn p-2 text-slate-400 hover:text-white flex flex-col items-center transition-colors group" id="nav-map">
                <i data-lucide="map" class="w-7 h-7 group-hover:scale-110 transition-transform"></i>
            </button>

            <button onclick="navigateTo('weather')" class="nav-btn p-2 text-slate-400 hover:text-white flex flex-col items-center transition-colors group" id="nav-weather">
                <i data-lucide="cloud-sun" class="w-7 h-7 group-hover:scale-110 transition-transform"></i>
            </button>

            <button onclick="navigateTo('reels')" class="nav-btn p-2 text-slate-400 hover:text-white flex flex-col items-center transition-colors group" id="nav-reels">
                <i data-lucide="film" class="w-7 h-7 group-hover:scale-110 transition-transform"></i>
            </button>
            
            <button onclick="navigateTo('profile')" class="nav-btn p-2 text-slate-400 hover:text-white flex flex-col items-center transition-colors group" id="nav-profile">
                <div class="w-7 h-7 rounded-full overflow-hidden border border-white/30 group-hover:border-white transition-colors">
                    <img id="nav-profile-img" src="https://api.dicebear.com/7.x/avataaars/svg?seed=Guest" class="w-full h-full object-cover">
                </div>
            </button>
        </div>
    </div>

    <!-- MODAL MAP SETTINGS (New Feature: iPhone Style Layers) -->
    <div id="mapSettingsModal" class="fixed inset-0 z-[10000] bg-black translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-white/10 shrink-0" style="padding-top: calc(1rem + env(safe-area-inset-top));">
            <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="layers" class="text-blue-400"></i> Tampilan Peta</h3>
            <button onclick="closeMapSettings()" class="p-2 text-slate-400 hover:bg-neutral-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-6 overflow-y-auto flex-1">
            <div class="space-y-6 max-w-2xl mx-auto">
                <!-- Base Map Section -->
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Jenis Peta Dasar</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="setBaseMap('satellite')" id="btn-map-sat" class="relative h-24 rounded-xl overflow-hidden border-2 border-blue-500 group transition-all">
                            <img src="https://mt1.google.com/vt/lyrs=y&x=10&y=6&z=4" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center font-bold text-white text-sm">Satelit</div>
                        </button>
                        <button onclick="setBaseMap('street')" id="btn-map-street" class="relative h-24 rounded-xl overflow-hidden border-2 border-transparent group transition-all">
                            <img src="https://mt1.google.com/vt/lyrs=m&x=10&y=6&z=4" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center font-bold text-white text-sm">Google Maps</div>
                        </button>
                        <button onclick="setBaseMap('ocean')" id="btn-map-ocean" class="relative h-24 rounded-xl overflow-hidden border-2 border-transparent group transition-all">
                            <img src="https://server.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/4/6/10" class="w-full h-full object-cover opacity-70 group-hover:opacity-100 transition-opacity">
                            <div class="absolute inset-0 bg-black/30 flex items-center justify-center font-bold text-white text-sm text-center leading-tight">Laut<br><span class="text-[9px] font-normal">(Depth)</span></div>
                        </button>
                    </div>
                </div>

                <!-- Offline Map Section -->
                <div class="bg-neutral-900/50 p-4 rounded-xl border border-white/5">
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Mode Offline (Laut Lepas)</h4>
                    <p class="text-[10px] text-slate-400 mb-3 leading-relaxed">Download area peta yang sedang tampil di layar agar tetap bisa dibuka saat tidak ada sinyal (Blank Spot).</p>
                    <button id="btn-download-map" onclick="downloadOfflineMap()" class="w-full bg-neutral-800 hover:bg-neutral-700 text-white text-xs font-bold py-3 rounded-lg flex items-center justify-center gap-2 transition-colors border border-white/10"><i data-lucide="download-cloud" class="w-4 h-4"></i> Download Area Ini</button>
                    
                    <!-- Daftar Peta Offline -->
                    <div id="offline-maps-list" class="mt-4 space-y-2 max-h-40 overflow-y-auto pr-1 custom-scrollbar"></div>
                </div>

                <!-- Weather Overlay Section -->
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Lapisan Peta (Multi-Layer)</h4>
                    <div class="space-y-3">
                        <!-- Rain Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-blue-500/20 p-2 rounded-lg text-blue-400"><i data-lucide="cloud-rain" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Hujan</p><p class="text-[10px] text-slate-400">Radar presipitasi</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('rain')" id="toggle-rain"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Clouds Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-neutral-700/20 p-2 rounded-lg text-slate-300"><i data-lucide="cloud" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Awan</p><p class="text-[10px] text-slate-400">Tutupan awan satelit</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('clouds')" id="toggle-clouds"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Wind Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400"><i data-lucide="wind" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Angin</p><p class="text-[10px] text-slate-400">Kecepatan angin (OWM)</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('wind')" id="toggle-wind"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Quake Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-500/20 p-2 rounded-lg text-red-400"><i data-lucide="activity" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Gempa</p><p class="text-[10px] text-slate-400">Gempa terkini > 2.5SR</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('quake')" id="toggle-quake"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Seamap Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-orange-500/20 p-2 rounded-lg text-orange-400"><i data-lucide="anchor" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Navigasi</p><p class="text-[10px] text-slate-400">OpenSeaMap</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('seamap')" id="toggle-seamap"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Pressure Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-purple-500/20 p-2 rounded-lg text-purple-400"><i data-lucide="gauge" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Tekanan</p><p class="text-[10px] text-slate-400">Isobar Udara</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('pressure')" id="toggle-pressure"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Fish Heatmap Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-pink-500/20 p-2 rounded-lg text-pink-400"><i data-lucide="scan-line" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Heatmap Ikan</p><p class="text-[10px] text-slate-400">Area tangkapan terbanyak (Komunitas)</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('fish_heat')" id="toggle-fish_heat"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Sea Temp (SST) Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-500/20 p-2 rounded-lg text-indigo-400"><i data-lucide="thermometer-sun" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Suhu Laut (SST)</p><p class="text-[10px] text-slate-400">NASA GHRSST (Gratis)</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('sst')" id="toggle-sst"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Chlorophyll Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400"><i data-lucide="sprout" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Klorofil-a</p><p class="text-[10px] text-slate-400">Plankton/PPDPI (NASA)</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('chlorophyll')" id="toggle-chlorophyll"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Bathymetry (GEBCO) Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-cyan-500/20 p-2 rounded-lg text-cyan-400"><i data-lucide="waves" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Kontur Kedalaman</p><p class="text-[10px] text-slate-400">Overlay GEBCO (Shaded Relief)</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('bathymetry')" id="toggle-bathymetry"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Sonar Toggle (New Feature) -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-emerald-500/20 p-2 rounded-lg text-emerald-400"><i data-lucide="radar" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Peta Laut (Chart)</p><p class="text-[10px] text-slate-400">Kontur Kedalaman & Navigasi</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('sonar')" id="toggle-sonar"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>

                        <!-- Live Ship Radar Toggle -->
                        <div class="flex items-center justify-between bg-neutral-900/50 p-3 rounded-xl border border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-red-500/20 p-2 rounded-lg text-red-400"><i data-lucide="ship" class="w-5 h-5"></i></div>
                                <div><p class="font-bold text-sm text-white">Live Radar Kapal</p><p class="text-[10px] text-slate-400">Posisi kapal real-time (AIS)</p></div>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" class="sr-only peer" onchange="toggleLayer('ship_radar')" id="toggle-ship_radar"><div class="w-11 h-6 bg-neutral-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div></label>
                        </div>
                    </div>
                    <p class="text-[10px] text-slate-500 mt-4 leading-relaxed bg-black/50 p-3 rounded-lg border border-white/5">
                        <i data-lucide="info" class="w-3 h-3 inline mr-1"></i> 
                        <b>Hujan, Awan, Suhu & Klorofil</b> (Gratis). <b>Angin</b> memerlukan API Key.
                    </p>
                </div>

                <!-- Windy Embed Section -->
                <div>
                    <h4 class="text-xs font-bold text-slate-400 uppercase mb-3">Peta Cuaca Lengkap (Windy)</h4>
                    <button onclick="openWindy()" class="w-full h-24 rounded-xl bg-gradient-to-r from-purple-600 to-blue-600 relative overflow-hidden group shadow-lg border border-white/10 transition-transform active:scale-95">
                        <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                            <i data-lucide="wind" class="w-8 h-8 text-white mb-1"></i>
                            <span class="font-black text-white text-lg uppercase tracking-wider">Buka Windy.com</span>
                            <span class="text-[10px] text-white/90 font-bold bg-black/20 px-2 py-1 rounded-full mt-1 backdrop-blur-sm">Angin ‚Ä¢ Ombak ‚Ä¢ Badai ‚Ä¢ Suhu</span>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL ROUTE STEPS (New Feature: Internal Navigation) -->
    <div id="routeModal" class="fixed inset-0 z-[10000] bg-black translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-white/10 shrink-0" style="padding-top: calc(1rem + env(safe-area-inset-top));">
            <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="navigation" class="text-blue-400"></i> Rute Perjalanan</h3>
            <button onclick="closeRouteModal()" class="p-2 text-slate-400 hover:bg-neutral-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="p-0 overflow-y-auto flex-1 bg-neutral-900/50">
            <div id="route-steps-list" class="divide-y divide-white/5">
                <!-- Steps injected here -->
            </div>
        </div>
    </div>

    <!-- MODAL WINDY (New Feature: Full Windy Embed) -->
    <div id="windyModal" class="fixed inset-0 z-[11000] bg-black translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-white/10 shrink-0 bg-black" style="padding-top: calc(1rem + env(safe-area-inset-top));">
            <h3 class="text-xl font-bold text-white flex items-center gap-2"><i data-lucide="wind" class="text-red-400"></i> Windy Map</h3>
            <button onclick="closeWindy()" class="p-2 text-slate-400 hover:bg-neutral-800 rounded-full"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="flex-1 relative bg-black">
            <iframe id="windy-frame" class="absolute inset-0 w-full h-full border-none" src="" allow="geolocation"></iframe>
        </div>
    </div>

    <!-- MODAL ADD SPOT -->
    <div id="addModal" class="fixed inset-0 z-[10000] bg-black translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10 shrink-0" style="padding-top: calc(1rem + env(safe-area-inset-top));">
            <h3 id="addModalTitle" class="text-lg font-bold flex items-center gap-2"><i data-lucide="map-pin" class="text-blue-500"></i> <span data-i18n="modal_add_title">Tambah Spot</span></h3>
            <button onclick="closeModal()" class="p-2 text-slate-400 hover:bg-slate-800 rounded-full" aria-label="Tutup modal"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <!-- Content -->
        <div class="p-6 overflow-y-auto flex-1">
            <div class="space-y-6 max-w-2xl mx-auto">
                
                <!-- Photo Upload Area -->
                <div class="relative group">
                    <input type="file" id="spotPhoto" accept="image/*" class="hidden" onchange="previewImage(this)">
                    
                    <!-- Placeholder State -->
                    <div id="upload-placeholder" class="w-full aspect-video bg-neutral-800/50 rounded-2xl border-2 border-dashed border-neutral-600 flex flex-col items-center justify-center cursor-pointer hover:bg-neutral-800 hover:border-blue-500 hover:text-blue-400 transition-all group-hover:shadow-lg group-hover:shadow-blue-900/20" onclick="document.getElementById('spotPhoto').click()">
                        <div class="w-16 h-16 bg-neutral-700/50 rounded-full flex items-center justify-center mb-3 group-hover:scale-110 transition-transform">
                            <i data-lucide="camera" class="w-8 h-8 text-slate-400 group-hover:text-blue-400"></i>
                        </div>
                        <span class="text-xs font-bold uppercase tracking-wider text-slate-400" data-i18n="label_add_photo">Tambah Foto (Opsional)</span>
                        <p class="text-[10px] text-slate-500 mt-1">Ketuk untuk ambil gambar</p>
                    </div>
                    
                    <!-- Preview State -->
                    <div id="imagePreviewContainer" class="hidden relative w-full aspect-video rounded-2xl overflow-hidden border border-white/10 shadow-xl">
                        <img id="imagePreview" class="w-full h-full object-cover">
                        <div class="absolute inset-0 bg-black/20"></div>
                        <button onclick="clearImage()" class="absolute top-3 right-3 bg-black/60 backdrop-blur-md p-2 rounded-full text-white hover:bg-red-500 transition-colors z-10" aria-label="Hapus foto"><i data-lucide="x" class="w-4 h-4"></i></button>
                        <button onclick="document.getElementById('spotPhoto').click()" class="absolute bottom-3 right-3 bg-black/60 backdrop-blur-md px-3 py-1.5 rounded-lg text-white text-xs font-bold hover:bg-blue-600 transition-colors flex items-center gap-2"><i data-lucide="refresh-cw" class="w-3 h-3"></i> Ganti</button>
                    </div>
                </div>

                <!-- Form Inputs -->
                <div class="space-y-4">
                    <!-- Name -->
                    <div class="bg-neutral-800/50 border border-white/5 rounded-xl p-1 focus-within:border-blue-500/50 focus-within:bg-neutral-800 transition-all">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase px-3 pt-2">Nama Spot / Ikan</label>
                        <input type="text" id="spotName" data-i18n-placeholder="placeholder_spotname" placeholder="Contoh: Ikan Kakap Merah" class="w-full bg-transparent border-none text-white p-3 pt-1 outline-none font-bold text-lg placeholder-slate-600">
                    </div>

                    <!-- Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <!-- Weight -->
                        <div class="bg-neutral-800/50 border border-white/5 rounded-xl p-1 focus-within:border-emerald-500/50 focus-within:bg-neutral-800 transition-all">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase px-3 pt-2">Berat (Kg)</label>
                            <div class="flex items-center px-3 pb-1">
                                <input type="number" id="spotWeight" placeholder="0.0" step="0.1" class="w-full bg-transparent border-none text-emerald-400 p-0 outline-none font-black text-2xl placeholder-slate-700">
                                <span class="text-xs font-bold text-slate-500">KG</span>
                            </div>
                        </div>

                        <!-- Rating -->
                        <div class="bg-neutral-800/50 border border-white/5 rounded-xl p-1 flex flex-col items-center justify-center">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Rating Spot</label>
                            <div class="flex gap-1" id="star-rating-container">
                                <button type="button" onclick="setRating(1)" class="star-btn p-1 text-slate-600 hover:text-yellow-400 transition-colors"><i data-lucide="star" class="w-5 h-5 fill-current"></i></button>
                                <button type="button" onclick="setRating(2)" class="star-btn p-1 text-slate-600 hover:text-yellow-400 transition-colors"><i data-lucide="star" class="w-5 h-5 fill-current"></i></button>
                                <button type="button" onclick="setRating(3)" class="star-btn p-1 text-slate-600 hover:text-yellow-400 transition-colors"><i data-lucide="star" class="w-5 h-5 fill-current"></i></button>
                                <button type="button" onclick="setRating(4)" class="star-btn p-1 text-slate-600 hover:text-yellow-400 transition-colors"><i data-lucide="star" class="w-5 h-5 fill-current"></i></button>
                                <button type="button" onclick="setRating(5)" class="star-btn p-1 text-slate-600 hover:text-yellow-400 transition-colors"><i data-lucide="star" class="w-5 h-5 fill-current"></i></button>
                            </div>
                            <input type="hidden" id="spotRating" value="">
                        </div>
                    </div>

                    <!-- Comment -->
                    <div class="bg-neutral-800/50 border border-white/5 rounded-xl p-1 focus-within:border-blue-500/50 focus-within:bg-neutral-800 transition-all">
                        <label class="block text-[10px] font-bold text-slate-500 uppercase px-3 pt-2">Catatan / Cerita</label>
                        <textarea id="spotComment" rows="3" data-i18n-placeholder="placeholder_comment" placeholder="Ceritakan pengalaman memancing di sini..." class="w-full bg-transparent border-none text-slate-300 p-3 pt-1 outline-none text-sm placeholder-slate-600 resize-none"></textarea>
                    </div>
                </div>

                <!-- Street View Info -->
                <div id="sv-preview" class="bg-neutral-900/80 p-4 rounded-xl border border-dashed border-neutral-700 flex items-start gap-3">
                    <div class="bg-neutral-800 p-2 rounded-lg shrink-0">
                        <i data-lucide="map-pin" class="w-5 h-5 text-blue-400"></i>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-white uppercase mb-0.5">Lokasi GPS</p>
                        <p class="text-[10px] text-slate-400 leading-relaxed">Koordinat akan diambil otomatis dari foto atau lokasi yang dipilih di peta.</p>
                    </div>
                </div>
            </div>
        </div>
        <!-- Footer -->
        <div class="p-4 border-t border-white/10 shrink-0 bg-black pb-safe">
            <div class="max-w-2xl mx-auto">
                <button id="btnSaveSpot" onclick="saveSpotCloud()" class="w-full bg-blue-600 py-4 rounded-xl font-bold hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/50" data-i18n="btn_save_cloud">Simpan ke Cloud</button>
            </div>
        </div>
    </div>

    <!-- MODAL SPOT DETAIL (New Feature) -->
    <div id="spotDetailModal" class="fixed inset-0 z-[10000] bg-black/90 hidden flex items-center justify-center p-4">
        <div class="bg-black w-full max-w-xl p-0 rounded-[2.5rem] animate-in zoom-in duration-300 relative m-0 shadow-2xl border border-white/5 overflow-hidden flex flex-col h-[90dvh] md:h-auto md:max-h-[90vh]">
            <!-- Header Image -->
            <div class="relative h-72 md:h-96 bg-black shrink-0 group">
                <img id="detail-img" src="" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110">
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/40 to-transparent"></div>
                
                <!-- Favorite Button -->
                <button onclick="toggleFavorite()" id="btn-favorite" class="absolute top-4 right-16 p-3 bg-black/30 rounded-full hover:bg-black/50 text-white backdrop-blur-md border border-white/10 transition-all active:scale-90" aria-label="Tambah ke favorit"><i data-lucide="heart" class="w-6 h-6"></i></button>
                
                <button onclick="closeSpotDetail()" class="absolute top-4 right-4 p-3 bg-black/30 rounded-full hover:bg-black/50 text-white backdrop-blur-md border border-white/10 transition-all active:scale-90" aria-label="Tutup detail"><i data-lucide="x" class="w-6 h-6"></i></button>
                
                <div class="absolute bottom-0 left-0 right-0 p-6 pb-8 bg-gradient-to-t from-black to-transparent">
                    <h3 class="text-3xl md:text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-slate-400 leading-tight drop-shadow-sm" id="detail-name">Nama Spot</h3>
                    <div class="flex items-center gap-3 mt-3">
                        <div class="flex items-center gap-1 text-yellow-400" id="detail-rating-stars"></div>
                        <span class="text-sm font-bold text-slate-400" id="detail-rating-text">(0.0)</span>
                    </div>
                </div>
            </div>
            
            <!-- Content -->
            <div class="px-6 pb-6 overflow-y-auto no-scrollbar flex-1 -mt-4 relative z-10">
                <div class="flex items-center justify-between mb-8 bg-neutral-900/80 backdrop-blur-md p-4 rounded-3xl border border-white/5 shadow-xl">
                    <div class="text-center">
                        <p class="text-[10px] text-slate-400 uppercase font-bold" data-i18n="label_contributors">Kontributor</p>
                        <p class="text-2xl font-black text-white" id="detail-count">0</p>
                    </div>
                    <div class="text-center border-l border-white/10 pl-4">
                        <p class="text-[10px] text-slate-400 uppercase font-bold" data-i18n="label_record">Rekor Ikan</p>
                        <p class="text-2xl font-black text-emerald-400" id="detail-max-weight">-</p>
                    </div>
                    <button onclick="openStreetViewFromDetail()" class="bg-blue-600/20 border border-blue-500/50 p-3 rounded-xl text-blue-400 hover:bg-blue-600 hover:text-white transition-all" aria-label="Lihat Street View"><i data-lucide="eye" class="w-5 h-5"></i></button>
                </div>

                <h4 class="text-xs font-bold text-slate-500 uppercase mb-4 flex items-center gap-2 tracking-wider"><i data-lucide="message-square" class="w-3 h-3"></i> Ulasan & Foto Komunitas</h4>
                <div id="detail-comments" class="space-y-4 pb-20"></div>
            </div>

            <!-- Footer Action -->
            <div class="absolute bottom-0 left-0 right-0 p-4 bg-black/80 backdrop-blur-xl border-t border-white/5 z-20 pb-safe">
                <button onclick="addContribution()" class="w-full bg-gradient-to-r from-blue-600 to-blue-500 py-4 rounded-2xl font-bold shadow-lg hover:shadow-blue-500/25 transition-all flex items-center justify-center gap-2 text-white">
                    <i data-lucide="camera" class="w-4 h-4"></i> <span data-i18n="btn_add_review">Tambah Foto / Ulasan Disini</span>
                </button>
            </div>
        </div>
    </div>

    <!-- MODAL WEATHER DETAIL (New Feature) -->
    <div id="weatherDetailModal" class="fixed inset-0 z-[10000] bg-black hidden animate-in slide-in-from-bottom duration-300">
        <div class="w-full h-full p-6 overflow-y-auto no-scrollbar relative" style="padding-top: calc(1.5rem + env(safe-area-inset-top));">
            <button onclick="closeDetailModal()" class="absolute top-4 right-4 p-2 bg-neutral-800 rounded-full hover:bg-neutral-700" aria-label="Tutup detail cuaca"><i data-lucide="x" class="w-4 h-4"></i></button>
            <h3 class="text-xl font-bold mb-1 flex items-center gap-2" id="detail-title">Detail Cuaca</h3>
            <p class="text-xs text-slate-400 mb-4" id="detail-date">...</p>
            
            <!-- AI Insight Box (New Feature) -->
            <div class="bg-gradient-to-br from-neutral-800 to-neutral-900 p-4 rounded-2xl border border-blue-500/30 mb-5 relative overflow-hidden shadow-lg group">
                <div class="absolute top-0 right-0 p-3 opacity-10 group-hover:opacity-20 transition-opacity"><i data-lucide="bot" class="w-16 h-16 text-blue-400"></i></div>
                <h4 class="text-xs font-bold text-blue-300 uppercase mb-3 flex items-center gap-2"><i data-lucide="sparkles" class="w-4 h-4 text-yellow-400"></i> Analisa Cerdas (AI)</h4>
                <div id="ai-insight-content" class="grid md:grid-cols-2 gap-4 text-sm text-slate-200 leading-relaxed">
                    <!-- Left Column for Warnings -->
                    <div id="ai-warnings-container" class="space-y-2">
                        <p class="text-xs text-slate-500 animate-pulse">Menganalisa potensi bahaya...</p>
                    </div>
                    <!-- Right Column for Recommendations -->
                    <div id="ai-recommendations-container" class="space-y-2"></div>
                </div>
            </div>

            <!-- Chart Tabs -->
            <div class="flex gap-2 mb-4 overflow-x-auto no-scrollbar">
                <button onclick="switchChart('temp')" id="tab-temp" class="chart-tab active px-3 py-1.5 rounded-lg text-[10px] font-bold border border-white/10 bg-neutral-800/50 text-slate-400 transition-all whitespace-nowrap flex items-center gap-1"><i data-lucide="thermometer" class="w-3 h-3"></i> Suhu & Hujan</button>
                <button onclick="switchChart('solunar')" id="tab-solunar" class="chart-tab px-3 py-1.5 rounded-lg text-[10px] font-bold border border-white/10 bg-neutral-800/50 text-slate-400 transition-all whitespace-nowrap flex items-center gap-1"><i data-lucide="moon-star" class="w-3 h-3"></i> Aktivitas Ikan</button>
                <button onclick="switchChart('wind')" id="tab-wind" class="chart-tab px-3 py-1.5 rounded-lg text-[10px] font-bold border border-white/10 bg-neutral-800/50 text-slate-400 transition-all whitespace-nowrap flex items-center gap-1"><i data-lucide="wind" class="w-3 h-3"></i> Angin</button>
                <button onclick="switchChart('wave')" id="tab-wave" class="chart-tab px-3 py-1.5 rounded-lg text-[10px] font-bold border border-white/10 bg-neutral-800/50 text-slate-400 transition-all whitespace-nowrap flex items-center gap-1"><i data-lucide="waves" class="w-3 h-3"></i> Ombak</button>
            </div>

            <!-- Chart Container -->
            <div class="w-full h-64 md:h-80 rounded-xl p-4 relative mb-4 cursor-crosshair touch-none" id="chart-wrapper">
                <!-- SVG Chart will be injected here -->
                <div id="chart-container" class="w-full h-full"></div>
                <div id="chart-tooltip"></div>
                <div id="chart-cursor" class="absolute top-4 bottom-4 w-px bg-white/30 hidden border-l border-dashed border-white"></div>
            </div>
            
            <!-- Advanced Details Grid -->
            <h4 class="text-xs font-bold text-slate-400 uppercase mb-2">Data Atmosfer</h4>
            <div class="grid grid-cols-3 gap-2 mb-4">
                <div class="bg-neutral-800/30 p-2 rounded-xl border border-white/5 text-center">
                    <p class="text-[9px] text-slate-500 uppercase">Kelembaban</p>
                    <p class="text-sm font-bold text-blue-300" id="det-humidity">-%</p>
                </div>
                <div class="bg-neutral-800/30 p-2 rounded-xl border border-white/5 text-center">
                    <p class="text-[9px] text-slate-500 uppercase">Tekanan</p>
                    <p class="text-sm font-bold text-emerald-300" id="det-pressure">- hPa</p>
                </div>
                <div class="bg-neutral-800/30 p-2 rounded-xl border border-white/5 text-center">
                    <p class="text-[9px] text-slate-500 uppercase">UV Index</p>
                    <p class="text-sm font-bold text-yellow-300" id="det-uv">-</p>
                </div>
            </div>
            
            <!-- Summary -->
            <div class="p-3 bg-neutral-800/50 rounded-xl border border-neutral-700/50 text-xs text-slate-300" id="rain-summary">
                <!-- Summary -->
            </div>
        </div>
    </div>

    <!-- MODAL FAVORITES LIST -->
    <div id="favoritesModal" class="fixed inset-0 z-[10000] bg-black translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
        <!-- Header -->
        <div class="flex items-center justify-between p-4 border-b border-white/10 shrink-0 header-safe">
                <h3 class="text-xl font-bold flex items-center gap-2 text-white"><i data-lucide="heart" class="text-red-500 fill-red-500"></i> Spot Favorit</h3>
            <button onclick="closeFavorites()" class="p-2 text-slate-400 hover:bg-neutral-800 rounded-full" aria-label="Tutup favorit"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <!-- Content -->
        <div class="p-6 overflow-y-auto flex-1">
            <div id="favorites-list" class="space-y-3 max-w-2xl mx-auto">
                <!-- List items injected here -->
            </div>
        </div>
    </div>

    <!-- MODAL LEGEND / INFO MARKER -->
    <!-- Diubah menjadi hidden container untuk dipindahkan ke view-settings -->
    <div id="legendModal" class="hidden">
        <!-- Content -->
        <div class="space-y-4">
            <div class="space-y-4 max-w-2xl mx-auto">
                <!-- Language Selector (Moved here) -->
                <div class="flex items-center justify-between bg-neutral-800/50 p-3 rounded-xl border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-neutral-700 rounded-full flex items-center justify-center"><i data-lucide="languages" class="text-white w-4 h-4"></i></div>
                        <span class="font-bold text-white text-sm">Bahasa / Language</span>
                    </div>
                    <select onchange="changeLanguage(this.value)" class="bg-black text-white text-xs p-2 rounded-lg border border-white/10 outline-none"><option value="id">üáÆüá© ID</option><option value="en">üá∫üá∏ EN</option><option value="jp">üáØüáµ JP</option></select>
                </div>

                <!-- Theme Toggle (New Feature) -->
                <div class="flex items-center justify-between bg-neutral-800/50 p-3 rounded-xl border border-white/5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 bg-neutral-700 rounded-full flex items-center justify-center"><i data-lucide="sun-moon" class="text-white w-4 h-4"></i></div>
                        <span class="font-bold text-white text-sm">Tampilan / Theme</span>
                    </div>
                    <button onclick="toggleTheme()" id="theme-btn" class="bg-black text-white text-xs px-3 py-2 rounded-lg border border-white/10 font-bold transition-colors">‚òÄÔ∏è Light</button>
                </div>

                <!-- Auto Update Button (New Feature) -->
                <div class="bg-neutral-800/50 p-3 rounded-xl border border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="bg-blue-600/20 p-2 rounded-lg text-blue-400"><i data-lucide="refresh-cw" class="w-5 h-5"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Update Aplikasi</p>
                            <p class="text-[10px] text-slate-400">Otomatis & Manual</p>
                        </div>
                    </div>
                    <button onclick="checkForUpdate()" id="btn-check-update" class="bg-blue-600 hover:bg-blue-500 text-white text-[10px] font-bold px-3 py-2 rounded-lg transition-colors shadow-lg">Cek Update</button>
                </div>

                <div class="flex items-center gap-3 bg-neutral-800/50 p-3 rounded-xl border border-white/5">
                    <div class="w-8 h-8 bg-blue-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center shrink-0"><i data-lucide="fish" class="text-white w-4 h-4"></i></div>
                    <div>
                        <p class="font-bold text-white">Biru (Biasa)</p>
                        <p class="text-xs text-slate-400">Ikan kecil (< 3kg) atau belum ada data berat.</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-neutral-800/50 p-3 rounded-xl border border-white/5">
                    <div class="w-8 h-8 bg-yellow-500 rounded-full border-2 border-white shadow-lg flex items-center justify-center shrink-0"><i data-lucide="fish" class="text-white w-4 h-4"></i></div>
                    <div>
                        <p class="font-bold text-white">Kuning (Sedang)</p>
                        <p class="text-xs text-slate-400">Ikan lumayan besar (3kg - 10kg).</p>
                    </div>
                </div>
                <div class="flex items-center gap-3 bg-neutral-800/50 p-3 rounded-xl border border-white/5">
                    <div class="w-8 h-8 bg-red-600 rounded-full border-2 border-white shadow-lg flex items-center justify-center shrink-0 relative">
                        <i data-lucide="fish" class="text-white w-4 h-4"></i>
                        <div class="absolute -top-1 -right-1 w-2 h-2 bg-white rounded-full flex items-center justify-center"><div class="w-1 h-1 bg-red-600 rounded-full animate-ping"></div></div>
                    </div>
                    <div>
                        <p class="font-bold text-white">Merah (Monster)</p>
                        <p class="text-xs text-slate-400">Ikan Raksasa / Rekor (> 10kg).</p>
                    </div>
                </div>

                <!-- Icon Guide Section -->
                <h4 class="text-xs font-bold text-slate-400 uppercase mt-6 mb-2">Panduan Ikon & Fitur</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <div class="bg-neutral-800/30 p-3 rounded-xl border border-white/5 flex items-center gap-3">
                        <div class="bg-neutral-700 p-2 rounded-lg shrink-0"><i data-lucide="star" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Rating Spot</p>
                            <p class="text-[10px] text-slate-400">Menunjukkan kualitas spot berdasarkan ulasan pemancing lain.</p>
                        </div>
                    </div>
                    <div class="bg-neutral-800/30 p-3 rounded-xl border border-white/5 flex items-center gap-3">
                        <div class="bg-neutral-700 p-2 rounded-lg shrink-0"><i data-lucide="layers" class="w-4 h-4 text-blue-400"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Lapisan Peta</p>
                            <p class="text-[10px] text-slate-400">Mengganti mode Satelit/Jalan dan lapisan cuaca (Hujan/Angin).</p>
                        </div>
                    </div>
                    <div class="bg-neutral-800/30 p-3 rounded-xl border border-white/5 flex items-center gap-3">
                        <div class="bg-neutral-700 p-2 rounded-lg shrink-0"><i data-lucide="cloud-sun" class="w-4 h-4 text-white"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Info Cuaca</p>
                            <p class="text-[10px] text-slate-400">Melihat detail ombak, angin, suhu, dan pasang surut.</p>
                        </div>
                    </div>
                    <div class="bg-neutral-800/30 p-3 rounded-xl border border-white/5 flex items-center gap-3">
                        <div class="bg-neutral-700 p-2 rounded-lg shrink-0"><i data-lucide="navigation" class="w-4 h-4 text-blue-400"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Lokasi Saya</p>
                            <p class="text-[10px] text-slate-400">Memusatkan peta ke posisi GPS Anda saat ini.</p>
                        </div>
                    </div>
                    <div class="bg-neutral-800/30 p-3 rounded-xl border border-white/5 flex items-center gap-3">
                        <div class="bg-neutral-700 p-2 rounded-lg shrink-0"><i data-lucide="locate-fixed" class="w-4 h-4 text-emerald-400"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Spot Terdekat</p>
                            <p class="text-[10px] text-slate-400">Otomatis mencari dan mengarahkan ke spot mancing terdekat.</p>
                        </div>
                    </div>
                    <div class="bg-neutral-800/30 p-3 rounded-xl border border-white/5 flex items-center gap-3">
                        <div class="bg-neutral-700 p-2 rounded-lg shrink-0"><i data-lucide="heart" class="w-4 h-4 text-red-500 fill-red-500"></i></div>
                        <div>
                            <p class="text-xs font-bold text-white">Favorit</p>
                            <p class="text-[10px] text-slate-400">Menyimpan spot pilihan agar mudah diakses kembali.</p>
                        </div>
                    </div>
                    
                    <!-- Tombol Tambahan untuk Favorites di Menu -->
                    <div class="mt-6">
                        <button onclick="openFavorites()" class="w-full bg-neutral-800 hover:bg-neutral-700 text-white py-4 rounded-xl font-bold flex items-center justify-center gap-2 border border-white/10">
                            <i data-lucide="heart" class="text-red-500 fill-red-500"></i> Buka Spot Favorit
                        </button>
                    </div>

                </div>

                <div class="pt-6 pb-2 text-center">
                    <p class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Powered by Wayan & StoryBali</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL LIGHTBOX (New Feature) -->
    <div id="lightboxModal" class="fixed inset-0 z-[11000] bg-black/95 hidden flex items-center justify-center p-2 backdrop-blur-sm transition-opacity duration-300" onclick="closeImageLightbox()">
        <button onclick="closeImageLightbox()" class="absolute right-6 p-3 bg-white/10 rounded-full text-white hover:bg-white/20 transition-colors z-50" style="top: calc(1.5rem + env(safe-area-inset-top));" aria-label="Tutup gambar"><i data-lucide="x" class="w-8 h-8"></i></button>
        <img id="lightbox-img" src="" class="max-w-full max-h-[90vh] object-contain rounded-lg shadow-2xl animate-in zoom-in duration-300" onclick="event.stopPropagation()">
    </div>

    <!-- MODAL CUSTOM ALERT (New Feature) -->
    <div id="customAlertModal" class="fixed inset-0 z-[12000] bg-black/80 hidden items-center justify-center p-4 backdrop-blur-sm" onclick="closeCustomAlert()">
        <div class="glass w-full max-w-sm p-8 rounded-[2rem] animate-in zoom-in-90 duration-300 relative m-4 shadow-2xl text-center" onclick="event.stopPropagation()">
            <div id="alert-icon-container" class="w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 border-4">
                <i id="alert-icon" data-lucide="alert-triangle" class="w-8 h-8"></i>
            </div>
            <h3 id="alert-title" class="text-xl font-bold text-white mb-2">Judul Peringatan</h3>
            <p id="alert-message" class="text-sm text-slate-300 mb-6 leading-relaxed">Pesan peringatan akan muncul di sini.</p>
            <button onclick="closeCustomAlert()" id="alert-button" class="w-full py-3 rounded-xl font-bold transition-all shadow-lg text-white">Mengerti</button>
        </div>
    </div>

    <!-- ONBOARDING TOUR OVERLAY -->
    <div id="tour-highlight" class="tour-highlight hidden"></div>
    <div id="tour-tooltip" class="tour-tooltip hidden glass p-5 rounded-2xl border border-blue-500/30 shadow-[0_0_50px_rgba(0,0,0,0.5)]">
        <div class="flex items-start gap-4">
            <div class="bg-blue-600 p-2 rounded-lg shrink-0 text-white shadow-lg shadow-blue-600/30">
                <i id="tour-icon" data-lucide="info" class="w-6 h-6"></i>
            </div>
            <div class="flex-1">
                <h4 id="tour-title" class="font-bold text-white text-sm mb-1">Title</h4>
                <p id="tour-desc" class="text-xs text-slate-300 leading-relaxed">Description goes here.</p>
            </div>
        </div>
        <div class="flex items-center justify-between border-t border-white/10 pt-3 mt-4">
            <span id="tour-step-count" class="text-[10px] text-slate-500 font-mono font-bold">1/5</span>
            <div class="flex gap-2">
                <button onclick="endTour()" class="text-xs text-slate-500 hover:text-slate-300 font-medium px-2 transition-colors">Lewati</button>
                <button id="tour-prev-btn" onclick="prevTourStep()" class="hidden text-xs text-slate-300 hover:text-white font-medium px-2 transition-colors">Kembali</button>
                <button id="tour-next-btn" onclick="nextTourStep()" class="bg-blue-600 hover:bg-blue-500 text-white text-xs font-bold px-4 py-2 rounded-lg transition-all shadow-lg shadow-blue-900/50 active:scale-95">Lanjut</button>
            </div>
        </div>
    </div>

    <!-- MODAL STORY VIEWER (New Feature) -->
    <div id="storyViewerModal" class="fixed inset-0 z-[11000] bg-black hidden animate-in fade-in duration-300 overflow-hidden">
        <!-- Wrapper for Scaling Effect (Agar background hitam tetap full saat ditekan) -->
        <div id="story-scale-wrapper" class="relative w-full h-full flex flex-col transition-transform duration-200 ease-out origin-center">
            <!-- Progress Bar -->
            <div id="story-bars-container" class="flex gap-1 p-2 z-20 absolute top-0 left-0 w-full" style="padding-top: calc(0.5rem + env(safe-area-inset-top));">
                <!-- Bars injected via JS -->
            </div>
            
            <!-- Header -->
            <div class="flex items-center justify-between px-4 pb-4 z-20 absolute top-0 left-0 w-full bg-gradient-to-b from-black/80 to-transparent" style="padding-top: calc(2rem + env(safe-area-inset-top));">
                <div class="flex items-center gap-3">
                    <div id="story-header-icon" class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center border border-white/20"><i data-lucide="bot" class="w-4 h-4 text-white"></i></div>
                    <div>
                        <p id="story-header-title" class="font-bold text-white text-sm leading-none">AI Analysis</p>
                        <p class="text-[10px] text-slate-300 leading-none mt-1">Live Update</p>
                    </div>
                </div>
                <button onclick="closeStoryViewer()" class="text-white/80 hover:text-white p-2 bg-black/20 rounded-full backdrop-blur-md"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>

            <!-- Content Area -->
            <div id="story-content" class="flex-1 flex flex-col items-center justify-center p-6 relative h-full w-full">
                <!-- Dynamic Content Injected Here -->
            </div>
        </div>

        <!-- Navigation Overlay (Invisible) -->
        <div class="absolute inset-0 z-10 flex">
            <div class="w-1/3 h-full" onmousedown="handleStoryTouch('start', null, event)" onmouseup="handleStoryTouch('end', 'prev', event)" ontouchstart="handleStoryTouch('start', null, event)" ontouchend="handleStoryTouch('end', 'prev', event)"></div>
            <div class="w-2/3 h-full" onmousedown="handleStoryTouch('start', null, event)" onmouseup="handleStoryTouch('end', 'next', event)" ontouchstart="handleStoryTouch('start', null, event)" ontouchend="handleStoryTouch('end', 'next', event)"></div>
        </div>
    </div>

    <!-- MODAL EDIT PROFILE (New Feature) -->
    <div id="editProfileModal" class="fixed inset-0 z-[10000] bg-black translate-y-full transition-transform duration-300 ease-in-out flex flex-col">
        <div class="flex items-center justify-between p-4 border-b border-white/10 shrink-0" style="padding-top: calc(1rem + env(safe-area-inset-top));">
            <h3 class="text-lg font-bold text-white">Edit Profil</h3>
            <button onclick="closeEditProfile()" class="text-blue-400 font-bold text-sm">Batal</button>
        </div>
        <div class="p-6 space-y-6">
            <div class="flex flex-col items-center gap-3">
                <div class="w-24 h-24 rounded-full overflow-hidden border-2 border-white/20">
                    <img id="edit-profile-preview" src="" class="w-full h-full object-cover">
                </div>
                <p class="text-xs text-slate-500">Avatar dibuat otomatis dari nama</p>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nama Tampilan</label>
                    <input type="text" id="edit-name" class="w-full bg-neutral-900 border border-white/10 rounded-lg p-3 text-white focus:border-blue-500 outline-none font-bold" placeholder="Nama Anda">
                    <p class="text-[10px] text-slate-500 mt-1">Nama ini akan muncul di komentar & postingan.</p>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Bio</label>
                    <textarea id="edit-bio" rows="4" class="w-full bg-neutral-900 border border-white/10 rounded-lg p-3 text-white focus:border-blue-500 outline-none resize-none text-sm" placeholder="Ceritakan tentang diri Anda..."></textarea>
                </div>
            </div>
            
            <button onclick="saveProfile()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-500 transition-colors shadow-lg shadow-blue-900/20">Simpan Perubahan</button>
        </div>
    </div>

    <!-- Firebase SDK (Compat version agar mudah digunakan) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script src="weather.js"></script>
    <script src="script.js"></script>
    
    <script>
        // --- NEW: Dynamic Home Feed Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            // --- NEW: Feed Video Observer (Lazy Play) ---
            // Observer ini akan memutar video feed HANYA saat terlihat di layar
            window.feedVideoObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const video = entry.target;
                    if (entry.isIntersecting) {
                        video.play().catch(() => {});
                    } else {
                        video.pause();
                    }
                });
            }, { threshold: 0.5 });

            // Muat feed dan data widget secara paralel (Dipanggil SETELAH Observer siap)
            loadHomeFeed();
            loadHomeWidgetData(); 
            
            // --- NEW: PULL TO REFRESH LOGIC ---
            const homeView = document.getElementById('view-home');
            const contentWrapper = document.getElementById('home-content-wrapper');
            const ptrIcon = document.getElementById('ptr-icon');
            let ptrStartY = 0;
            let isPulling = false;

            if (homeView && contentWrapper && ptrIcon) {
                homeView.addEventListener('touchstart', (e) => {
                    if (homeView.scrollTop <= 0) {
                        ptrStartY = e.touches[0].clientY;
                    }
                }, {passive: true});

                homeView.addEventListener('touchmove', (e) => {
                    const y = e.touches[0].clientY;
                    const diff = y - ptrStartY;
                    
                    // Hanya aktifkan jika scroll di paling atas dan tarik ke bawah
                    if (homeView.scrollTop <= 0 && diff > 0) {
                        isPulling = true;
                        if (e.cancelable) e.preventDefault(); // Mencegah browser scroll bawaan (karet)
                        // Visual feedback (Tarik spinner ke bawah)
                        if (diff < 200) { 
                            contentWrapper.style.transform = `translateY(${diff * 0.4}px)`;
                            ptrIcon.style.transform = `scale(${Math.min(1, diff / 100)})`;
                        }
                    } else {
                        isPulling = false;
                        contentWrapper.style.transform = `translateY(0)`;
                        ptrIcon.style.transform = `scale(0)`;
                    }
                }, {passive: false}); // Passive false agar bisa preventDefault

                homeView.addEventListener('touchend', async (e) => {
                    if (!isPulling) return;
                    isPulling = false;
                    const y = e.changedTouches[0].clientY;
                    const diff = y - ptrStartY;

                    if (diff > 100 && homeView.scrollTop <= 0) { // Threshold refresh
                        // Trigger Refresh Animation
                        contentWrapper.style.transform = `translateY(60px)`; // Tahan posisi
                        ptrIcon.style.transform = `scale(1)`;
                        if (navigator.vibrate) navigator.vibrate(50);

                        await loadHomeFeed(); // Refresh Feed
                        if(typeof loadHomeWidgetData === 'function') loadHomeWidgetData(); // Refresh Widget
                        
                        // Reset UI setelah selesai
                        setTimeout(() => {
                            contentWrapper.style.transform = `translateY(0)`;
                            ptrIcon.style.transform = `scale(0)`;
                        }, 500);
                    } else {
                        // Batal (Tarik kurang jauh)
                        contentWrapper.style.transform = `translateY(0)`;
                        ptrIcon.style.transform = `scale(0)`;
                    }
                    ptrStartY = 0;
                });
            }
        });

        // Template Skeleton Feed (Reusable)
        const FEED_SKELETON_HTML = `
            <div class="animate-pulse w-full">
                <div class="flex items-center gap-3 px-4 py-3">
                    <div class="w-10 h-10 rounded-full bg-neutral-800"></div>
                    <div class="flex-1 space-y-2">
                        <div class="h-3 w-32 bg-neutral-800 rounded"></div>
                        <div class="h-2 w-20 bg-neutral-800 rounded"></div>
                    </div>
                </div>
                <div class="w-full aspect-[4/5] bg-neutral-800"></div>
                <div class="px-4 pt-3 space-y-2">
                    <div class="h-3 w-24 bg-neutral-800 rounded"></div>
                    <div class="h-2 w-full bg-neutral-800 rounded"></div>
                    <div class="h-2 w-2/3 bg-neutral-800 rounded"></div>
                </div>
            </div>`;

        // --- NEW: Translation Feature ---
        window.translateCaption = async function(btn, elementId) {
            const el = document.getElementById(elementId);
            if (!el) return;

            // Toggle back to original
            if (btn.dataset.translated === "true") {
                el.innerHTML = btn.dataset.original;
                btn.innerText = "Terjemahkan";
                btn.dataset.translated = "false";
                return;
            }

            // Save original HTML
            if (!btn.dataset.original) {
                btn.dataset.original = el.innerHTML;
            }

            const originalText = el.innerText; // Get plain text
            const originalBtnText = btn.innerText;
            
            btn.innerText = "Menterjemahkan...";
            btn.disabled = true;
            btn.classList.add("animate-pulse");

            try {
                // Use Google Translate via CORS Proxy
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=id&dt=t&q=${encodeURIComponent(originalText)}`;
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                const data = await res.json();

                if (data && data[0]) {
                    let translated = "";
                    data[0].forEach(item => { if (item[0]) translated += item[0]; });
                    
                    // Replace newlines with <br>
                    el.innerHTML = translated.replace(/\n/g, '<br>');
                    btn.innerText = "Lihat Asli";
                    btn.dataset.translated = "true";
                } else {
                    throw new Error("Translation failed");
                }
            } catch (e) {
                console.error(e);
                btn.innerText = "Gagal";
                setTimeout(() => { btn.innerText = originalBtnText; }, 2000);
            } finally {
                btn.disabled = false;
                btn.classList.remove("animate-pulse");
            }
        };

        // Helper: Toggle Mute (New Feature)
        window.toggleMute = function(btn) {
            const container = btn.closest('.relative');
            const video = container.querySelector('video');
            if(video) {
                video.muted = !video.muted;
                btn.innerHTML = video.muted ? '<i data-lucide="volume-x" class="w-5 h-5"></i>' : '<i data-lucide="volume-2" class="w-5 h-5"></i>';
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        // --- NEW: Video Subtitle Feature ---
        window.toggleVideoSubtitles = async function(btn, captionId) {
            const container = btn.closest('.relative');
            const overlay = container.querySelector('.subtitle-overlay');
            const captionEl = document.getElementById(captionId);
            
            if (!overlay || !captionEl) return;

            // Toggle Off
            if (!overlay.classList.contains('hidden')) {
                overlay.classList.add('hidden');
                btn.classList.remove('bg-blue-600', 'border-blue-500');
                btn.classList.add('bg-black/40', 'border-white/10');
                return;
            }

            // Toggle On
            overlay.classList.remove('hidden');
            btn.classList.remove('bg-black/40', 'border-white/10');
            btn.classList.add('bg-blue-600', 'border-blue-500');
            
            // Check if already translated
            if (overlay.dataset.translated === "true") return;

            const originalBtnHtml = btn.innerHTML;
            overlay.innerHTML = '<div class="flex items-center justify-center gap-2"><i data-lucide="loader" class="w-3 h-3 animate-spin"></i> <span class="opacity-80">Menerjemahkan suara...</span></div>';
            btn.innerHTML = '<i data-lucide="loader" class="w-3 h-3 animate-spin"></i> Loading...';
            if(typeof lucide !== 'undefined') lucide.createIcons();

            const originalText = captionEl.innerText.trim();
            
            try {
                // Use Google Translate via CORS Proxy
                const url = `https://translate.googleapis.com/translate_a/single?client=gtx&sl=auto&tl=id&dt=t&q=${encodeURIComponent(originalText)}`;
                const res = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
                const data = await res.json();

                if (data && data[0]) {
                    let translated = "";
                    data[0].forEach(item => { if (item[0]) translated += item[0]; });
                    overlay.innerText = translated;
                    overlay.dataset.translated = "true";
                } else {
                    overlay.innerText = "Gagal menerjemahkan.";
                }
            } catch (e) {
                console.error(e);
                overlay.innerText = "Gagal memuat subtitle.";
            } finally {
                btn.innerHTML = originalBtnHtml;
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        };

        // --- NEW: Open Reel from Feed Data ---
        function openReelFromFeed(mode, container) {
            const data = externalPostDataCache[mode];
            if (data) {
                let startTime = 0;
                let isMuted = false;
                if (container) {
                    const v = container.querySelector('video');
                    if (v) { startTime = v.currentTime; isMuted = v.muted; }
                }
                // Pass status video ke fungsi Reels
                openReelWithVideo(data, startTime, isMuted);
            }
        }

        // Global store untuk menyimpan data feed saat ini agar mudah diakses saat klik
        let currentFeedItems = [];

        function openMainFeedReel(identifier, container) {
            let postData = null;
            
            // 1. Cari di Memory (Data Feed yang sedang tampil) - Lebih Akurat
            if (currentFeedItems.length > 0) {
                const foundItem = currentFeedItems.find(item => {
                    const d = item.data;
                    return d.id == identifier || d.video === identifier;
                });
                if (foundItem) {
                    // Konversi format data feed ke format reels
                    const found = foundItem.data;
                    postData = {
                        url: found.video,
                        title: found.description || found.comment || found.locationName,
                        user: found.userName || 'User',
                        likes: found.likes || 0,
                        comments: found.comments ? found.comments.length : 0,
                        sourceLabel: 'Community',
                        thumbnail: found.image,
                        userAvatar: found.userPhoto
                    };
                }
            }

            // 2. Fallback ke Cache jika tidak ketemu di memory
            if (!postData) {
            try {
                const cached = JSON.parse(localStorage.getItem('feed_cache') || '{}');
                const spots = Array.isArray(cached) ? cached : (cached.spots || []);
                // Cari berdasarkan ID atau Video URL (Fallback jika ID tidak ada/berubah)
                const found = spots.find(s => s.id == identifier || s.video === identifier);
                if (found) {
                    postData = {
                        url: found.video,
                        title: found.comment || found.name,
                        user: found.uid ? found.uid.split('@')[0] : 'User',
                        likes: found.likes || 0,
                        comments: 0,
                        sourceLabel: 'Community',
                        thumbnail: found.photo,
                        userAvatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${found.uid || 'User'}`
                    };
                }
            } catch(e) {}
            }

            if (postData) {
                let startTime = 0;
                let isMuted = false;
                if (container) {
                    const v = container.querySelector('video');
                    if (v) { startTime = v.currentTime; isMuted = v.muted; }
                }
                openReelWithVideo(postData, startTime, isMuted);
            } else {
                console.warn("Video data not found for identifier:", identifier);
            }
        }

        async function loadHomeFeed() {
            const container = document.getElementById('home-feed-container');
            if(!container) return;
            
            // Reset cache postingan eksternal agar selalu update saat refresh feed (Navigasi)
            externalPostDataCache = {};
            
            // Gunakan URL Google Sheet yang sudah ada di script.js
            // Fallback URL jika variabel tidak ditemukan
            const SHEET_URL = (typeof GOOGLE_SCRIPT_URL !== 'undefined') ? GOOGLE_SCRIPT_URL : "https://script.google.com/macros/s/AKfycbybJe6cBuciSnj4j4hmm3nN4C860Sen9RVht6b1O5cZoRpkwvBoDLw6jTkYa4tmUas1/exec";

            // Helper: Ubah Link YouTube jadi Embed
            const getEmbedUrl = (url) => {
                if (!url) return null;
                let vId = '';
                try {
                    if (url.includes('shorts/')) vId = url.split('shorts/')[1].split('?')[0];
                    else if (url.includes('v=')) vId = url.split('v=')[1].split('&')[0];
                    else if (url.includes('youtu.be/')) vId = url.split('youtu.be/')[1].split('?')[0];
                    if(vId) return `https://www.youtube.com/embed/${vId}?autoplay=0&controls=1&rel=0&playsinline=1&mute=1`;
                } catch(e) { return null; }
                return null;
            };

            // Helper Render (Agar bisa dipanggil 2x: Cache & Network)
            const render = (rawData, allComments = []) => {
                if (!Array.isArray(rawData)) return;

                // Filter: Tampilkan jika ada Foto ATAU Video
                const feedItems = rawData.filter(item => item.photo || item.video).map(item => ({
                    data: {
                        ...item,
                        image: item.photo,
                        video: item.video, // Pastikan ada kolom 'video' di Google Sheet
                        userName: item.uid ? item.uid.split('@')[0] : 'Pengguna',
                        userPhoto: `https://api.dicebear.com/7.x/avataaars/svg?seed=${item.uid || 'User'}`,
                        locationName: item.name || 'Lokasi Spot',
                        likes: item.likes || 0,
                        description: item.comment,
                        weight: item.weight,
                        lat: (typeof item.lat === 'string') ? parseFloat(item.lat.replace(',', '.')) : item.lat,
                        lng: (typeof item.lng === 'string') ? parseFloat(item.lng.replace(',', '.')) : item.lng,
                        comments: allComments.filter(c => c.postId === item.id)
                    },
                    time: item.createdAt ? new Date(item.createdAt) : new Date()
                }));

                // Update Global Store untuk akses klik
                currentFeedItems = feedItems;

                feedItems.sort((a, b) => b.time - a.time);
                const displayItems = feedItems.slice(0, 5);

                container.innerHTML = '';
                if (displayItems.length === 0) {
                    // Tampilan jika kosong: Tampilkan pesan + Tombol + Konten Eksternal
                    container.innerHTML = `
                        <div class="text-center text-slate-500 py-8 text-sm flex flex-col items-center gap-3">
                            <div class="bg-neutral-800 p-3 rounded-full"><i data-lucide="image" class="w-6 h-6 opacity-50"></i></div>
                            <p>Belum ada postingan pengguna.<br>Jadilah yang pertama memposting!</p>
                            <button onclick="openAddModal()" class="text-blue-400 font-bold text-xs hover:text-white transition-colors border border-blue-500/30 px-4 py-2 rounded-full">Tambah Spot Baru</button>
                        </div>
                    `;
                    
                    // Tetap tampilkan konten eksternal (Wikipedia/Resep) agar tidak kosong melompong
                    const extEl = document.createElement('div');
                    extEl.id = 'external-feed-post-empty';
                    extEl.className = "mb-4 border-b border-white/5 pb-4";
                    container.appendChild(extEl);
                    loadExternalFeedPost('external-feed-post-empty', 'mix');
                    
                    if(typeof lucide !== 'undefined') lucide.createIcons();
                    return;
                }

                // --- NEW: Randomize Widget Order (Agar posisi widget dinamis/natural) ---
                // Hapus index 5 (Wikipedia Widget lama) karena akan kita buat jadi Postingan Tetap
                let widgetIndices = [0, 1, 2, 3, 4];
                // Fisher-Yates Shuffle (Algoritma Pengacakan)
                for (let i = widgetIndices.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [widgetIndices[i], widgetIndices[j]] = [widgetIndices[j], widgetIndices[i]];
                }

                // Tentukan posisi video secara acak (antara index 2, 3, atau 4)
                // const videoPostIndex = 2; // Dipindahkan ke logika loop di bawah

                displayItems.forEach((item, index) => {
                    const d = item.data;
                    const timeAgo = getTimeAgo(item.time);
                    const weight = d.weight ? `${d.weight} KG` : null;
                    const comment = d.description || d.comment || 'Spot baru ditambahkan!';
                    const embedUrl = getEmbedUrl(d.video);
                    const isRawVideo = d.video && !embedUrl;
                    // Gunakan ID atau Video URL sebagai identifier (Fallback)
                    const postId = d.id || d.video; 

                    // Verified Badge SVG (Instagram Style)
                    const verifiedBadge = `<svg class="w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.69L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2 3.4-1.46 3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12z" fill="#3b82f6"/><path d="M10 15.17L6.12 11.29L7.53 9.87L10 12.34L16.47 5.87L17.88 7.29L10 15.17Z" fill="black"/></svg>`;

                    const el = document.createElement('div');
                    
                    // Generate Daftar Komentar (Hidden by default)
                    let commentsListHtml = '';
                    if (d.comments && d.comments.length > 0) {
                        commentsListHtml = `<div id="comments-list-${postId}" class="hidden mt-2 space-y-1 animate-in fade-in slide-in-from-top-1">` + 
                            d.comments.map(c => `<p class="text-xs text-slate-300"><span class="font-bold text-white mr-1">${c.userName}</span>${c.text}</p>`).join('') +
                        `</div>`;
                    }

                    // Instagram Style: Full width, no card wrapper
                    el.className = "bg-black mb-1 pb-2 border-b border-neutral-800 animate-in fade-in slide-in-from-bottom-8 duration-700 cv-auto";
                    el.innerHTML = `
                        <!-- Header -->
                        <div class="flex items-center justify-between px-3 py-2.5">
                            <div class="flex items-center gap-2.5">
                                <div class="w-8 h-8 rounded-full p-[1.5px] bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500">
                                    <div class="w-full h-full rounded-full border border-black overflow-hidden bg-neutral-800">
                                    <img src="${d.userPhoto}" loading="lazy" class="w-full h-full object-cover">
                                </div>
                            </div>
                            <div>
                                <div class="flex items-center gap-1">
                                    <p class="text-sm font-semibold text-white truncate">${d.userName}</p>
                                    ${(d.video || d.userName === 'Wayan') ? verifiedBadge : ''}
                                </div>
                                <button onclick="if(typeof navigateTo === 'function') { navigateTo('map'); if(typeof map !== 'undefined') map.flyTo([${d.lat || 0}, ${d.lng || 0}], 15); }" class="text-xs text-blue-400 font-bold truncate hover:text-blue-300 transition-colors block text-left max-w-[200px]">
                                    Lihat Lokasi Spot
                                </button>
                            </div>
                        </div>
                        <button class="text-white"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                    </div>

                        <!-- Media -->
                        <div class="w-full bg-neutral-900 relative group overflow-hidden" ondblclick="handleDoubleTapLike('${postId}', this)">
                            ${embedUrl ? 
                                `<div class="aspect-[4/5] w-full"><iframe src="${embedUrl}" loading="lazy" class="w-full h-full border-0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>` 
                                : (isRawVideo ?
                                    `<div class="aspect-[4/5] w-full flex items-center justify-center bg-black relative cursor-pointer overflow-hidden" data-post-id="${postId}" onclick="openMainFeedReel(this.dataset.postId, this)">
                                        <video src="${d.video}" poster="${d.image || ''}" class="w-full h-full object-cover pointer-events-none feed-video" playsinline loop crossorigin="anonymous" preload="metadata" muted></video>
                                        <button onclick="event.stopPropagation(); toggleMute(this)" class="absolute bottom-3 right-3 z-20 bg-black/40 hover:bg-black/60 text-white p-2 rounded-full backdrop-blur-md transition-all border border-white/10">
                                            <i data-lucide="volume-x" class="w-5 h-5"></i>
                                        </button>
                                     </div>`
                                    : `<img src="${d.image}" class="w-full h-auto max-h-[600px] object-cover min-h-[300px]" loading="lazy">`
                                )
                            }
                            ${!embedUrl && weight ? `<div class="absolute bottom-3 right-3 bg-black/70 backdrop-blur-md px-2 py-1 rounded-md text-xs font-bold text-white flex items-center gap-1"><i data-lucide="fish" class="w-3 h-3 text-emerald-400"></i> ${weight}</div>` : ''}
                            
                            <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                                <i data-lucide="heart" class="w-24 h-24 text-white fill-white opacity-0 transform scale-0 transition-all duration-300 double-tap-heart drop-shadow-2xl"></i>
                            </div>
                        </div>

                        <!-- Actions & Caption -->
                        <div class="px-3 pt-3">
                            <div class="flex items-center justify-between mb-2">
                                <div class="flex items-center gap-4">
                                    <button onclick="handleLike('${postId}', this)" class="text-white hover:text-white/70 transition-colors group">
                                        <i data-lucide="heart" class="w-6 h-6 group-active:scale-75 transition-transform ${isPostLiked(postId) ? 'fill-red-500 text-red-500' : ''}"></i>
                                    </button>
                                    <button onclick="toggleCommentSection('${postId}')" class="text-white hover:text-white/70 transition-colors"><i data-lucide="message-circle" class="w-6 h-6 -rotate-90"></i></button>
                                    <button onclick="handleShare('${d.locationName}', '${comment}', '${d.image}')" class="text-white hover:text-white/70 transition-colors"><i data-lucide="send" class="w-6 h-6"></i></button>
                                </div>
                                <button onclick="handleSavePost('${postId}', this)" class="text-white hover:text-white/70 transition-colors group">
                                    <i data-lucide="bookmark" class="w-6 h-6 group-active:scale-75 transition-transform ${isPostSaved(d.lat, d.lng) ? 'fill-white text-white' : ''}"></i>
                                </button>
                            </div>
                            
                            <p class="text-sm font-semibold text-white mb-1"><span id="likes-count-${postId}">${d.likes || 0}</span> suka</p>
                            
                            <div class="text-sm text-white leading-snug mb-1">
                                <span class="font-semibold mr-1">${d.userName}</span>
                                <span id="caption-${postId}">${comment}</span>
                            </div>
                            <button onclick="translateCaption(this, 'caption-${postId}')" class="text-[10px] font-bold text-slate-500 hover:text-white mb-2 cursor-pointer">Terjemahkan</button>
                            
                            ${d.comments && d.comments.length > 0 ? `<button onclick="toggleCommentsList('${postId}')" class="text-sm text-neutral-400 mb-1">Lihat semua ${d.comments.length} komentar</button>` : ''}
                            
                            <!-- Comments List Container -->
                            ${commentsListHtml}

                            <p class="text-[10px] text-neutral-500 uppercase tracking-wide mb-3">${timeAgo}</p>

                            <!-- Comment Input Section (Hidden by default) -->
                            <div id="comment-section-${postId}" class="hidden mt-2 flex items-center gap-3 border-t border-white/10 pt-3">
                                <div class="w-7 h-7 rounded-full bg-slate-800 overflow-hidden shrink-0 border border-white/10">
                                    <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=${localStorage.getItem('guest_name') || 'Guest'}" class="w-full h-full object-cover">
                                </div>
                                <input type="text" id="comment-input-${postId}" class="bg-transparent border-none text-sm text-white flex-1 focus:outline-none placeholder-neutral-500" placeholder="Tambahkan komentar..." onkeypress="if(event.key === 'Enter') submitComment('${postId}')">
                                <button onclick="submitComment('${postId}')" class="text-blue-400 text-xs font-semibold hover:text-white transition-colors">Kirim</button>
                            </div>
                        </div>
                    `;
                    container.appendChild(el);
                    
                    // Observe video if exists (Lazy Play)
                    const vid = el.querySelector('video.feed-video');
                    if(vid && window.feedVideoObserver) window.feedVideoObserver.observe(vid);

                    // --- POSISI 1: Video (Di bawah postingan ke-1) ---
                    if (index === 0) {
                        const vidEl = document.createElement('div');
                        vidEl.id = 'external-feed-post-video';
                        vidEl.className = "mb-4 border-b border-white/5 pb-4";
                        container.appendChild(vidEl);
                        loadExternalFeedPost('external-feed-post-video', 'video'); // Mode Video Only
                    }

                    // --- POSISI 2: Resep / Fakta (Di bawah postingan ke-3) ---
                    if (index === 2) {
                        const extEl = document.createElement('div');
                        extEl.id = 'external-feed-post-mix';
                        extEl.className = "mb-4 border-b border-white/5 pb-4";
                        container.appendChild(extEl);
                        loadExternalFeedPost('external-feed-post-mix', 'mix'); // Mode Mix (Resep/Wiki)
                    }

                    // --- NEW: Inject Widget (AI/Weather) ---
                    // Sisipkan widget di sela-sela postingan secara acak
                    if (index < widgetIndices.length) {
                        const widgetType = widgetIndices[index];
                        const widget = createHomeWidget(widgetType);
                        if(widget) {
                            container.appendChild(widget);
                        }
                    }
                });
                if(typeof lucide !== 'undefined') lucide.createIcons();
            };

            // 1. CACHE DISABLED: Langsung tampilkan loading skeleton jika perlu, atau biarkan kosong sampai fetch selesai
            // Sesuai permintaan: Jangan ambil dari cache agar selalu fresh

            // 2. NETWORK SECOND: Ambil data baru di background
            try {
                // FIX: Tambahkan timestamp (?t=...) agar browser tidak menggunakan cache lama
                // Gunakan type=all untuk mengambil spot DAN komentar sekaligus
                const res = await fetch(`${SHEET_URL}?type=all&t=${Date.now()}`);
                const data = await res.json();

                // Cek format data (Object dengan spots & comments atau Array lama)
                if (data && (Array.isArray(data) || data.spots)) {
                    let spots = Array.isArray(data) ? data : (data.spots || []);
                    const comments = data.comments || [];
                    
                    // FIX: Pastikan setiap spot punya ID (Generate jika tidak ada)
                    spots = spots.map((s, i) => ({
                        ...s,
                        id: s.id || `gen_${Date.now()}_${i}`
                    }));

                    // Update UI (Tanpa Simpan Cache Feed)
                    // Kita tetap simpan 'videos' khusus reels ke cache terpisah jika perlu, tapi feed utama tidak.
                    // Namun agar Reels tetap jalan lancar, kita update cache HANYA untuk struktur videos, tapi tidak untuk render ulang feed nanti.
                    // Untuk simplifikasi sesuai request "jangan di save ke cache":
                    // localStorage.removeItem('feed_cache'); // Opsional: Hapus cache lama
                    
                    render(spots, comments);
                }
            } catch (e) {
                console.warn("Gagal fetch Google Sheet, bertahan dengan cache:", e);
                // Fallback ke data lokal user (Spot yang disimpan di HP) jika internet mati
                const local = JSON.parse(localStorage.getItem('spots') || '[]');
                render(local);
            }
        }

        // --- NEW: Fetch Weather Data specifically for Home Widget ---
        async function loadHomeWidgetData() {
            // Prioritaskan GPS, fallback ke cache, lalu IP
            let lat = localStorage.getItem('lastLat');
            let lng = localStorage.getItem('lastLng');

            if (!lat || !lng) {
                try {
                    const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 5000 }));
                    lat = pos.coords.latitude;
                    lng = pos.coords.longitude;
                } catch (e) {
                    console.warn("GPS failed for widget, using IP estimate.");
                    // Fallback to IP if everything else fails
                    try {
                        const res = await fetch('https://ipapi.co/json/');
                        const data = await res.json();
                        if (data.latitude) lat = data.latitude;
                        if (data.longitude) lng = data.longitude;
                    } catch (ipError) { /* Do nothing if IP fails */ }
                }
            }
            if (!lat || !lng) return; // Cannot get location

            // Fetch both weather and marine data in parallel
            const [weatherRes, marineRes] = await Promise.allSettled([fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current_weather=true&hourly=temperature_2m,precipitation_probability,weathercode,uv_index&daily=weathercode,temperature_2m_max,temperature_2m_min,sunrise,sunset&minutely_15=precipitation&timezone=auto`), fetch(`https://marine-api.open-meteo.com/v1/marine?latitude=${lat}&longitude=${lng}&hourly=sea_level_height_msl&timezone=auto`)]);
            
            if (weatherRes.status === 'fulfilled') {
                currentWeatherData = await weatherRes.value.json();
                // --- FIX: Force Update Widget UI Immediately ---
                const w1 = document.getElementById('home-weather-widget');
                if(w1) { w1.innerHTML = getHomeWidgetContent(); w1.dataset.status = 'loaded'; }
                
                const w2 = document.getElementById('home-storybali-widget');
                if(w2) { w2.innerHTML = getStoryBaliContent(); w2.dataset.status = 'loaded'; }
                
                const w3 = document.getElementById('home-forecast-widget');
                if(w3) { w3.innerHTML = getForecastWidgetContent(); w3.dataset.status = 'loaded'; }

                updateAIStories(); // --- NEW: Update Stories ---
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }
            if (marineRes.status === 'fulfilled') currentMarineData = await marineRes.value.json();
        }

        function getTimeAgo(date) { const s = Math.floor((new Date() - date)/1000); if(s<60) return "Baru saja"; const m=Math.floor(s/60); if(m<60) return m+" mnt lalu"; const h=Math.floor(m/60); if(h<24) return h+" jam lalu"; const d=Math.floor(h/24); return d+" hari lalu"; }

        // --- NEW: Home Widget Generator ---
        function createHomeWidget(index) {
            const el = document.createElement('div');
            el.className = "mx-4 mb-6 animate-in fade-in slide-in-from-bottom-4 duration-500";

            // Widget 1: AI Weather Insight (Postingan Wayan - Cuaca)
            if (index === 0) {
                el.id = 'home-weather-widget'; // ID untuk update otomatis
                el.innerHTML = getHomeWidgetContent();
                
                // Tandai status loading agar bisa di-update nanti jika data belum siap
                if (typeof currentWeatherData === 'undefined' || !currentWeatherData) {
                    el.dataset.status = 'loading';
                } else {
                    el.dataset.status = 'loaded';
                }
                return el;
            }

            // Widget 2: StoryBali (New Conversational Profile)
            if (index === 1) {
                el.id = 'home-storybali-widget';
                el.innerHTML = getStoryBaliContent();
                if (typeof currentWeatherData === 'undefined' || !currentWeatherData) {
                    el.dataset.status = 'loading';
                } else {
                    el.dataset.status = 'loaded';
                }
                return el;
            }

            // Widget 3: Info Gempa / Safety (Postingan Wayan - Safety)
            if (index === 2) {
                // Tampilan Statis ala Postingan untuk Info Keselamatan
                el.innerHTML = `
                    <div class="bg-slate-900 rounded-[1.5rem] p-4 border border-white/5 shadow-lg">
                        <div class="flex items-center gap-3 mb-4">
                            <div class="w-10 h-10 rounded-full bg-slate-700 overflow-hidden border border-white/10 p-[2px] bg-gradient-to-tr from-blue-500 to-cyan-500"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Wayan" class="w-full h-full object-cover rounded-full bg-slate-800"></div>
                            <div>
                                <p class="text-sm font-bold text-white flex items-center gap-1">Wayan <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.69L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2 3.4-1.46 3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12z" fill="#3b82f6"/><path d="M10 15.17L6.12 11.29L7.53 9.87L10 12.34L16.47 5.87L17.88 7.29L10 15.17Z" fill="black"/></svg></p>
                                <p class="text-[10px] text-slate-400">AI Safety ‚Ä¢ Info Laut</p>
                            </div>
                            <div class="ml-auto text-[10px] px-2 py-1 rounded-full bg-red-500/20 text-red-400 border border-white/5">Peringatan</div>
                        </div>
                        
                        <div class="bg-slate-900/50 rounded-2xl p-4 mb-3 border border-white/5 relative overflow-hidden">
                             <div class="flex items-center gap-3">
                                <div class="bg-red-500/20 p-2 rounded-lg text-red-400"><i data-lucide="activity" class="w-6 h-6"></i></div>
                                <div>
                                    <h4 class="font-bold text-white text-sm">Pantau Gempa & Tsunami</h4>
                                    <p class="text-xs text-slate-400">Selalu waspada saat memancing di pinggir pantai.</p>
                                </div>
                             </div>
                        </div>
                        
                        <p class="text-sm text-slate-300 mb-3 leading-relaxed">
                            Jangan lupa cek info gempa terkini sebelum berangkat. Keselamatan adalah prioritas utama, kawan! üé£
                        </p>
                        
                        <div class="flex items-center gap-4 border-t border-white/5 pt-3">
                            <button class="flex items-center gap-1 text-slate-400 hover:text-red-400 transition-colors"><i data-lucide="heart" class="w-4 h-4"></i> <span class="text-xs font-bold">88</span></button>
                            <button onclick="navigateTo('weather')" class="ml-auto text-xs font-bold text-blue-400 hover:text-white transition-colors">Cek Data Gempa</button>
                        </div>
                    </div>`;
                return el;
            }

            // Widget 4: Tips Mancing (Kapten Jack)
            if (index === 3) {
                el.innerHTML = getFishingTipWidget();
                return el;
            }

            // Widget 5: Forecast Summary (Ringkasan Cuaca)
            if (index === 4) {
                el.id = 'home-forecast-widget';
                el.innerHTML = getForecastWidgetContent();
                if (typeof currentWeatherData === 'undefined' || !currentWeatherData) {
                    el.dataset.status = 'loading';
                } else {
                    el.dataset.status = 'loaded';
                }
                return el;
            }
            return null;
        }

        // Helper: Generate Konten Widget AI (Dipisah agar bisa dipanggil ulang)
        function getHomeWidgetContent() {
            // Header Profile Wayan (Reusable)
            const header = `
                <div class="flex items-center gap-3 mb-4">
                    <div class="w-10 h-10 rounded-full bg-slate-700 overflow-hidden border border-white/10 p-[2px] bg-gradient-to-tr from-blue-500 to-cyan-500"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Wayan" class="w-full h-full object-cover rounded-full bg-slate-800"></div>
                    <div>
                        <p class="text-sm font-bold text-white flex items-center gap-1">Wayan <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.69L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2 3.4-1.46 3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12z" fill="#3b82f6"/><path d="M10 15.17L6.12 11.29L7.53 9.87L10 12.34L16.47 5.87L17.88 7.29L10 15.17Z" fill="black"/></svg></p>
                        <p class="text-[10px] text-slate-400">AI Fishing Assistant ‚Ä¢ Baru saja</p>
                    </div>
                    <div class="ml-auto text-[10px] px-2 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-white/5">Saran AI</div>
                </div>`;

            // --- FALLBACK TAMPILAN LOADING (Skeleton Post) ---
            if (typeof currentWeatherData === 'undefined' || !currentWeatherData || !currentWeatherData.current_weather) {
                return `
                    <div class="bg-neutral-900 rounded-[1.5rem] p-4 border border-white/5 shadow-lg animate-pulse">
                        ${header}
                        <div class="bg-neutral-800/50 rounded-2xl h-32 mb-3 border border-white/5"></div>
                        <div class="h-4 w-3/4 bg-slate-700 rounded mb-2"></div>
                        <div class="h-4 w-1/2 bg-slate-700 rounded animate-pulse"></div>
                    </div>`;
            }

            // --- TAMPILAN UTAMA (SETELAH DATA SIAP) ---
            const wx = currentWeatherData.current_weather;
            const hourly = currentWeatherData.hourly;
            const daily = currentWeatherData.daily;
            const now = new Date();
            const currentHour = now.getHours();

            // --- ANALISIS AI (Disederhanakan untuk ringkasan) ---
            let status = "Kondisi Stabil";
            let message = `Cuaca ${wx.windspeed < 15 ? 'tenang' : 'berangin'} (${wx.windspeed} km/h). Suhu ${Math.round(wx.temperature)}¬∞C.`;
            let icon = "check-circle";
            let color = "text-emerald-400";
            let bg = "bg-emerald-500/10 border-emerald-500/10"; // Lebih gelap & menyatu

            if (wx.weathercode >= 95) {
                status = "BAHAYA PETIR"; message = "Badai petir terdeteksi! Segera cari tempat berlindung. Joran karbon menghantar listrik.";
                icon = "cloud-lightning"; color = "text-red-500"; bg = "bg-red-500/10 border-red-500/10";
            } else if (wx.windspeed > 25) {
                status = "ANGIN KENCANG"; message = `Angin ${wx.windspeed} km/h. Waspada ombak tinggi.`;
                icon = "wind"; color = "text-yellow-400"; bg = "bg-yellow-500/10 border-yellow-500/10";
            } else if (wx.weathercode >= 51) {
                status = "HUJAN"; message = "Hujan sedang turun. Hati-hati jalanan licin.";
                icon = "cloud-rain"; color = "text-blue-400"; bg = "bg-blue-500/10 border-blue-500/10";
            }

            // --- DATA UNTUK MINI-CHART (6 Jam ke Depan) ---
            const chartData = [];
            const chartLabels = [];
            for (let i = 0; i < 6; i++) {
                const idx = currentHour + i;
                if (idx < hourly.time.length) {
                    chartLabels.push(`${(currentHour + i) % 24}:00`);
                    chartData.push({
                        temp: Math.round(hourly.temperature_2m[idx]),
                        pop: hourly.precipitation_probability[idx]
                    });
                }
            }

            // --- FUNGSI RENDER MINI-CHART (SVG) ---
            const renderMiniChart = () => {
                if (chartData.length === 0) return '';
                const w = 280, h = 80, pad = 5; // Lebar disesuaikan container
                const temps = chartData.map(d => d.temp);
                const minT = Math.min(...temps), maxT = Math.max(...temps);
                const rangeT = (maxT - minT) || 1;

                const getX = (i) => pad + (i / (chartData.length - 1)) * (w - 2 * pad);
                const getTempY = (v) => h - pad - ((v - minT) / rangeT) * (h - 2 * pad - 20); 
                const getRainY = (p) => h - ((p / 100) * (h * 0.5)); 

                // 1. Rain Bars
                let rainBars = chartData.map((d, i) =>
                    `<rect x="${getX(i) - 8}" y="${getRainY(d.pop)}" width="16" height="${h - getRainY(d.pop)}" fill="#3b82f6" opacity="${d.pop > 10 ? '0.5' : '0.1'}" rx="2" />`
                ).join('');

                // 2. Temperature Line
                let tempPath = `M ${getX(0)} ${getTempY(chartData[0].temp)}`;
                for (let i = 1; i < chartData.length; i++) tempPath += ` L ${getX(i)} ${getTempY(chartData[i].temp)}`;

                return `
                    <svg viewBox="0 0 ${w} ${h}" class="w-full h-full overflow-visible" preserveAspectRatio="none">
                        ${rainBars}
                        <path d="${tempPath}" fill="none" stroke="#facc15" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" style="filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5));" />
                        ${chartData.map((d, i) => `<circle cx="${getX(i)}" cy="${getTempY(d.temp)}" r="3" fill="#1e293b" stroke="#facc15" stroke-width="2" />`).join('')}
                        ${chartData.map((d, i) => `<text x="${getX(i)}" y="${h+12}" font-size="10" fill="#64748b" text-anchor="middle">${chartLabels[i]}</text>`).join('')}
                    </svg>`;
            };

            // --- DATA TAMBAHAN (UV & Humidity) ---
            const uv = hourly.uv_index ? hourly.uv_index[currentHour] : '-';
            const humidity = hourly.relativehumidity_2m ? hourly.relativehumidity_2m[currentHour] : '-';

            // --- KONTEN FINAL (POST STYLE) ---
            return `
                <div class="bg-neutral-900 rounded-[1.5rem] p-4 border border-white/5 shadow-lg">
                    ${header}
                    
                    <!-- Visual Content (Chart & Status) -->
                    <div class="${bg} rounded-2xl p-4 mb-3 border relative overflow-hidden group cursor-pointer" onclick="navigateTo('weather')">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <div class="bg-slate-900/50 p-1.5 rounded-full ${color} shrink-0"><i data-lucide="${icon}" class="w-5 h-5"></i></div>
                                <h4 class="font-bold text-white text-sm">AI: ${status}</h4>
                            </div>
                            <div class="flex items-center gap-3 text-[10px] text-slate-400 font-bold">
                                <span>UV: <span class="text-white">${uv}</span></span>
                                <span>Lembap: <span class="text-white">${humidity}%</span></span>
                            </div>
                        </div>
                        
                        <!-- Chart Area -->
                        <div class="w-full h-20 relative">
                            ${renderMiniChart()}
                        </div>
                    </div>

                    <!-- Text Advice -->
                    <p class="text-sm text-slate-300 mb-3 leading-relaxed">
                        ${message}
                    </p>

                    <!-- Footer Actions -->
                    <div class="flex items-center gap-4 border-t border-white/5 pt-3">
                        <button class="flex items-center gap-1 text-slate-400 hover:text-red-400 transition-colors"><i data-lucide="heart" class="w-4 h-4"></i> <span class="text-xs font-bold">124</span></button>
                        <button class="flex items-center gap-1 text-slate-400 hover:text-blue-400 transition-colors"><i data-lucide="message-circle" class="w-4 h-4"></i> <span class="text-xs font-bold">12</span></button>
                        <button onclick="navigateTo('weather')" class="ml-auto text-xs font-bold text-blue-400 hover:text-white transition-colors flex items-center gap-1">Lihat Detail Cuaca <i data-lucide="arrow-right" class="w-3 h-3"></i></button>
                    </div>
                </div>`;
        }

        // --- NEW: StoryBali Widget Content (Conversational) ---
        function getStoryBaliContent() {
            // Fallback Loading
            if (typeof currentWeatherData === 'undefined' || !currentWeatherData || !currentWeatherData.current_weather) {
                return `
                    <div class="bg-neutral-900 rounded-[1.5rem] p-4 border border-white/5 animate-pulse shadow-lg">
                        <div class="flex items-center gap-3 mb-3">
                            <div class="w-10 h-10 rounded-full bg-slate-700"></div>
                            <div class="h-4 w-32 bg-slate-700 rounded"></div>
                        </div>
                        <div class="h-20 bg-slate-700/50 rounded-xl"></div>
                    </div>`;
            }

            const wx = currentWeatherData.current_weather;
            const now = new Date();
            const currentHour = now.getHours();
            
            // 1. Analisa Pasang Surut (Conversational)
            let tideMsg = "Data laut lagi loading nih bro.";
            let isGoodTide = false;
            if (typeof currentMarineData !== 'undefined' && currentMarineData && currentMarineData.hourly) {
                const tides = currentMarineData.hourly.sea_level_height_msl;
                const tideNow = tides[currentHour];
                const tideNext = tides[currentHour + 1];
                if (tideNext > tideNow) {
                    tideMsg = "Air laut lagi <b>Pasang Naik</b> nih, ikan biasanya lapar dan merapat ke pinggir.";
                    isGoodTide = true;
                } else {
                    tideMsg = "Air laut sedang <b>Surut</b> perlahan. Coba cari lubuk yang agak dalam ya.";
                }
            }

            // 2.5. Analisa Fase Bulan (jika ada)
            let moonMsg = "";
            if (typeof moonPhase !== 'undefined') {
                // Fase Bulan Baru (0.0 - 0.05 atau 0.95 - 1.0)
                if (moonPhase < 0.05 || moonPhase > 0.95) {
                    moonMsg = "Langit gelap pas <b>Bulan Baru</b>, cocok buat mancing cumi atau ikan yang tertarik cahaya umpan.";
                } 
                // Fase Purnama (0.45 - 0.55)
                else if (moonPhase > 0.45 && moonPhase < 0.55) {
                    moonMsg = "Lagi <b>Bulan Purnama</b> bro! Arus pasang surut lagi kuat-kuatnya. Predator besar sering keluar cari makan.";
                }
            }

            // 2. Analisa Cuaca & Saran (Conversational)
            let greeting = "Halo Bro!";
            let wxMsg = "";
            let advice = "";
            let buttonsHtml = '';
            
            if (wx.weathercode >= 95) {
                greeting = "Waduh, Gawat Bro!";
                wxMsg = "Ada <b>Badai Petir</b> di luar sana. Jangan nekat melaut ya, joran karbon itu magnet petir!";
                advice = "Mending ngopi dulu di rumah sambil benerin tackle. Safety first!";
                buttonsHtml = `<button onclick="navigateTo('weather')" class="flex-1 bg-red-600/20 text-red-300 text-xs font-bold py-2.5 rounded-lg border border-red-500/30 hover:bg-red-600/40 transition-colors flex items-center justify-center gap-1"><i data-lucide="cloud-lightning" class="w-4 h-4"></i> Lihat Detail Badai</button>`;
            } else if (wx.weathercode >= 51) {
                greeting = "Sedia Jas Hujan?";
                wxMsg = "Hujan lagi turun membasahi spot. Agak licin dan pandangan terbatas.";
                advice = "Kalau maksa berangkat, hati-hati masuk angin. Tapi biasanya ikan lele atau patin malah ganas pas hujan.";
                buttonsHtml = `<button onclick="navigateTo('weather')" class="flex-1 bg-blue-600/20 text-blue-300 text-xs font-bold py-2.5 rounded-lg border border-blue-500/30 hover:bg-blue-600/40 transition-colors flex items-center justify-center gap-1"><i data-lucide="cloud-rain" class="w-4 h-4"></i> Cek Prediksi Hujan</button>`;
            } else if (wx.windspeed > 25) {
                greeting = "Angin Kencang Nih!";
                wxMsg = `Angin ${wx.windspeed} km/h, ombak pasti goyang dombret di tengah.`;
                advice = "Cari spot di muara atau teluk yang terlindung bukit biar aman dari angin.";
                buttonsHtml = `<button onclick="navigateTo('weather')" class="flex-1 bg-yellow-600/20 text-yellow-300 text-xs font-bold py-2.5 rounded-lg border border-yellow-500/30 hover:bg-yellow-600/40 transition-colors flex items-center justify-center gap-1"><i data-lucide="wind" class="w-4 h-4"></i> Cek Arah Angin</button>`;
            } else {
                greeting = "Cuaca Mantap Jiwa!";
                wxMsg = `Langit cerah, angin santai (${wx.windspeed} km/h). Asik banget buat casting atau dasaran.`;
                advice = isGoodTide ? "Kombinasi cuaca cerah & air pasang = <b>Potensi Strike Besar!</b> Gas sekarang bro!" : "Cuaca bagus, meski air surut, masih oke buat mancing santai di pinggiran.";
                buttonsHtml = `
                    <button onclick="navigateTo('weather')" class="flex-1 bg-blue-600/20 text-blue-300 text-xs font-bold py-2.5 rounded-lg border border-blue-500/30 hover:bg-blue-600/40 transition-colors">Info Cuaca</button>
                    <button onclick="if(typeof findNearestSpot === 'function') findNearestSpot()" class="flex-1 bg-emerald-600/20 text-emerald-300 text-xs font-bold py-2.5 rounded-lg border border-emerald-500/30 hover:bg-emerald-600/40 transition-colors">Cari Spot</button>
                `;
            }

            return `
                <div class="bg-gradient-to-br from-indigo-950 to-neutral-900 rounded-[1.5rem] p-4 border border-indigo-500/20 relative overflow-hidden shadow-xl mb-6">
                    <!-- Header -->
                    <div class="flex items-center gap-3 mb-4 relative z-10">
                        <div class="w-10 h-10 rounded-full bg-indigo-500 overflow-hidden border-2 border-white/20 shadow-md p-[2px] bg-gradient-to-tr from-indigo-400 to-purple-400">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=StoryBali&backgroundColor=b6e3f4" class="w-full h-full object-cover rounded-full bg-indigo-900">
                        </div>
                        <div>
                            <p class="text-sm font-bold text-white flex items-center gap-1">StoryBali</p>
                            <p class="text-[10px] text-indigo-200">Teman Mancingmu ‚Ä¢ Live Update</p>
                        </div>
                    </div>

                    <!-- Chat Bubble Style Content -->
                    <div class="bg-white/5 rounded-2xl p-3 mb-3 border border-white/5 relative z-10 backdrop-blur-sm">
                        <p class="text-sm font-bold text-white mb-1">"${greeting}"</p>
                        <p class="text-xs text-slate-300 leading-relaxed mb-2">${wxMsg}</p>
                        <div class="border-t border-white/10 pt-2 mt-2">
                            <p class="text-xs text-slate-300 leading-relaxed flex items-start gap-2"><i data-lucide="waves" class="w-3 h-3 mt-0.5 text-blue-400"></i> ${tideMsg}</p>
                            ${moonMsg ? `<p class="text-xs text-slate-300 leading-relaxed flex items-start gap-2 mt-2"><i data-lucide="moon" class="w-3 h-3 mt-0.5 text-yellow-400"></i> ${moonMsg}</p>` : ''}
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="flex items-center gap-2 mt-3 mb-3 relative z-10">
                        ${buttonsHtml}
                    </div>

                    <!-- Advice Footer -->
                    <div class="flex items-start gap-2 relative z-10 bg-emerald-500/10 p-2 rounded-xl border border-emerald-500/20">
                        <div class="text-emerald-400 shrink-0"><i data-lucide="lightbulb" class="w-4 h-4"></i></div>
                        <p class="text-xs text-emerald-100 italic leading-relaxed">"${advice}"</p>
                    </div>

                    <!-- Background Decoration -->
                    <div class="absolute -bottom-6 -right-6 opacity-5 rotate-12"><i data-lucide="fish" class="w-40 h-40 text-white"></i></div>
                </div>
            `;
        }

        // --- NEW: Fishing Tip Widget ---
        function getFishingTipWidget() {
            // Kategori Konten Edukasi yang Beragam
            const contentTypes = [
                {
                    type: 'tip',
                    title: 'Tips Pro',
                    icon: 'lightbulb',
                    color: 'text-yellow-400',
                    bg: 'bg-yellow-500/20',
                    border: 'border-yellow-500/20',
                    items: [
                        "Gunakan umpan hidup saat air keruh agar aroma lebih menyebar dan menarik predator.",
                        "Saat cuaca panas terik, ikan cenderung turun ke kedalaman. Coba teknik dasaran atau jigging.",
                        "Waktu terbaik mancing adalah saat pergantian cahaya (Sunrise/Sunset) atau 'Golden Hour'.",
                        "Cek mata kail Anda secara berkala, ketajaman adalah kunci strike yang sukses.",
                        "Jika arus deras, gunakan pemberat yang lebih pipih agar tidak mudah hanyut terbawa arus.",
                        "Ikan karang suka bersembunyi di celah. Hati-hati tersangkut, gunakan leader yang kuat!",
                        "Bawa air minum yang cukup, dehidrasi di laut itu berbahaya kawan. Safety first!",
                        "Perhatikan burung laut! Jika mereka menukik ke air, biasanya ada gerombolan ikan kecil yang dikejar predator."
                    ]
                },
                {
                    type: 'knot',
                    title: 'Tutorial Simpul',
                    icon: 'anchor',
                    color: 'text-blue-400',
                    bg: 'bg-blue-500/20',
                    border: 'border-blue-500/20',
                    items: [
                        "<b>Simpul Palomar:</b> Sangat kuat & mudah. Lipat senar, masukkan ke lubang kail, buat simpul biasa, lalu masukkan kail ke loop.",
                        "<b>Simpul FG Knot:</b> Wajib untuk sambungan PE ke Leader. Tipis dan kuat meluncur di ring guide joran.",
                        "<b>Simpul Clinch:</b> Putar ujung senar 5-7 kali di main line, masukkan ke loop dekat kail, lalu tarik perlahan.",
                        "<b>Simpul Snell:</b> Mengikat kail langsung di batang (shank) untuk hook up ratio yang lebih baik saat strike."
                    ]
                },
                {
                    type: 'gear',
                    title: 'Info Alat',
                    icon: 'settings',
                    color: 'text-emerald-400',
                    bg: 'bg-emerald-500/20',
                    border: 'border-emerald-500/20',
                    items: [
                        "<b>Memilih Joran:</b> Untuk casting, pilih joran carbon yang ringan (180cm). Untuk dasaran, pilih fiber solid yang kuat.",
                        "<b>Reel Spinning vs Baitcasting:</b> Spinning lebih mudah untuk pemula & serbaguna. Baitcasting lebih akurat tapi butuh latihan.",
                        "<b>Senar PE vs Nylon:</b> PE (Braided) lebih kuat & sensitif tapi mudah gesek karang. Nylon lebih elastis & tahan gesek.",
                        "<b>Ukuran Kail:</b> Sesuaikan dengan mulut ikan target, bukan badannya. Kail kecil lebih mudah tertelan (hook up)."
                    ]
                }
            ];

            // Pilih Kategori & Item secara Acak
            const category = contentTypes[Math.floor(Math.random() * contentTypes.length)];
            const item = category.items[Math.floor(Math.random() * category.items.length)];
            
            // Warna teks konten (sedikit lebih terang dari icon)
            const textColor = category.color.replace('400', '100');
            
            return `
                <div class="bg-neutral-900 rounded-[1.5rem] p-4 border border-white/5 shadow-lg">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-slate-700 overflow-hidden border border-white/10 p-[2px] bg-gradient-to-tr from-slate-700 to-slate-600"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Jack" class="w-full h-full object-cover rounded-full bg-slate-800"></div>
                        <div>
                            <p class="text-sm font-bold text-white flex items-center gap-1">Kapten Jack</p>
                            <p class="text-[10px] text-slate-400">Edukasi & Tips ‚Ä¢ Nelayan Senior</p>
                        </div>
                        <div class="ml-auto text-[10px] px-2 py-1 rounded-full ${category.bg} ${category.color} border border-white/5">${category.title}</div>
                    </div>
                    
                    <div class="${category.bg.replace('/20', '/10')} rounded-2xl p-4 mb-3 border ${category.border} relative overflow-hidden">
                         <div class="absolute -right-2 -bottom-2 opacity-10"><i data-lucide="${category.icon}" class="w-16 h-16 ${category.color}"></i></div>
                         <p class="text-sm font-medium ${textColor} italic leading-relaxed">"${item}"</p>
                    </div>
                    
                    <div class="flex items-center gap-4 border-t border-white/5 pt-3">
                        <button class="flex items-center gap-1 text-slate-400 hover:${category.color} transition-colors"><i data-lucide="thumbs-up" class="w-4 h-4"></i> <span class="text-xs font-bold">Berguna</span></button>
                        <button class="flex items-center gap-1 text-slate-400 hover:text-white transition-colors ml-auto"><i data-lucide="share-2" class="w-4 h-4"></i></button>
                    </div>
                </div>`;
        }

        // --- NEW: Forecast Summary Widget ---
        function getForecastWidgetContent() {
            if (typeof currentWeatherData === 'undefined' || !currentWeatherData || !currentWeatherData.daily) {
                return `<div class="bg-neutral-900 rounded-[1.5rem] p-4 border border-white/5 animate-pulse shadow-lg"><div class="flex items-center gap-3 mb-3"><div class="w-10 h-10 rounded-full bg-slate-700"></div><div class="h-4 w-32 bg-slate-700 rounded"></div></div><div class="h-20 bg-neutral-800/50 rounded-xl"></div></div>`;
            }
            
            const daily = currentWeatherData.daily;
            let forecastHtml = '';
            
            // Show next 3 days (Index 1, 2, 3)
            for(let i=1; i<=3; i++) {
                if(i >= daily.time.length) break;
                const date = new Date(daily.time[i]);
                const dayName = date.toLocaleDateString('id-ID', {weekday: 'short'});
                const maxTemp = Math.round(daily.temperature_2m_max[i]);
                const code = daily.weathercode[i];
                
                let icon = 'sun';
                let color = 'text-yellow-400';
                if(code > 3) { icon = 'cloud'; color = 'text-slate-300'; }
                if(code >= 51) { icon = 'cloud-rain'; color = 'text-blue-400'; }
                if(code >= 95) { icon = 'cloud-lightning'; color = 'text-purple-400'; }
                
                forecastHtml += `
                    <div class="flex flex-col items-center gap-1 p-3 bg-neutral-800/50 rounded-xl border border-white/5 flex-1 hover:bg-neutral-800 transition-colors">
                        <span class="text-[10px] text-slate-400 uppercase font-bold">${dayName}</span>
                        <i data-lucide="${icon}" class="w-6 h-6 ${color} my-1"></i>
                        <span class="text-sm font-bold text-white">${maxTemp}¬∞</span>
                    </div>
                `;
            }

            return `
                <div class="bg-neutral-900 rounded-[1.5rem] p-4 border border-white/5 shadow-lg">
                    <div class="flex items-center gap-3 mb-4">
                        <div class="w-10 h-10 rounded-full bg-slate-700 overflow-hidden border border-white/10 p-[2px] bg-gradient-to-tr from-blue-500 to-cyan-500"><img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Wayan" class="w-full h-full object-cover rounded-full bg-slate-800"></div>
                        <div>
                            <p class="text-sm font-bold text-white flex items-center gap-1">Wayan <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.69L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2 3.4-1.46 3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12z" fill="#3b82f6"/><path d="M10 15.17L6.12 11.29L7.53 9.87L10 12.34L16.47 5.87L17.88 7.29L10 15.17Z" fill="black"/></svg></p>
                            <p class="text-[10px] text-slate-400">Prakiraan 3 Hari</p>
                        </div>
                        <div class="ml-auto text-[10px] px-2 py-1 rounded-full bg-blue-500/20 text-blue-400 border border-white/5">Info</div>
                    </div>
                    
                    <div class="flex gap-2 mb-3">
                        ${forecastHtml}
                    </div>
                    
                    <button onclick="navigateTo('weather')" class="w-full text-xs font-bold text-blue-400 bg-neutral-800/50 border border-white/10 py-2.5 rounded-xl hover:bg-neutral-800 transition-colors flex items-center justify-center gap-2">
                        Lihat 10 Hari Kedepan <i data-lucide="arrow-right" class="w-3 h-3"></i>
                    </button>
                </div>`;
        }

        // --- NEW: AI STORIES LOGIC ---
        let storiesData = [];
        let currentStoryIndex = 0;
        let currentStoryPageIndex = 0;
        let storyInterval = null;
        let storyProgress = 0;
        let isStoryPaused = false;
        let storyTouchStartTime = 0;

        function updateAIStories() {
            const container = document.getElementById('ai-stories-container');
            if (!container || !currentWeatherData) return;

            // Tampilkan Skeleton jika data belum siap
            if (!currentWeatherData.current_weather) {
                container.innerHTML = Array(5).fill(0).map(() => `
                    <div class="flex flex-col items-center gap-2 shrink-0 animate-pulse">
                        <div class="w-[4.5rem] h-[4.5rem] rounded-full bg-neutral-800 border-2 border-neutral-900"></div>
                        <div class="h-2 w-12 bg-neutral-800 rounded"></div>
                    </div>`).join('');
                return;
            }

            const wx = currentWeatherData.current_weather;
            const hourly = currentWeatherData.hourly;
            
            storiesData = [];

            // 1. Story: Ringkasan (Wayan)
            const wayanPages = [];
            // Page 1: Intro
            wayanPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-900 via-purple-950 to-slate-900 -z-10"></div>
                    <div class="absolute inset-0 opacity-30 bg-[radial-gradient(ellipse_at_top_right,_var(--tw-gradient-stops))] from-purple-500/20 via-transparent to-transparent -z-10"></div>
                    <div class="text-center px-6 animate-in zoom-in-90 duration-500 relative z-10">
                        <div class="w-32 h-32 mx-auto mb-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 p-1 shadow-[0_0_50px_rgba(59,130,246,0.5)]">
                            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Wayan" class="w-full h-full rounded-full bg-slate-900">
                        </div>
                        <h2 class="text-4xl font-black text-white mb-4 tracking-tight">Halo, Kapten!</h2>
                        <p class="text-xl text-slate-200 leading-relaxed font-medium">
                            Suhu saat ini <b>${Math.round(wx.temperature)}¬∞C</b>.<br>
                            ${wx.windspeed > 20 ? 'Angin agak kencang, hati-hati ombak.' : 'Angin tenang, mantap buat casting!'}
                        </p>
                    </div>`
            });
            
            // Page 2: Safety Advice
            let safetyMsg = "Kondisi aman terkendali.";
            let safetyIcon = "shield-check";
            let safetyColor = "text-emerald-400";
            
            if (wx.weathercode >= 95) { safetyMsg = "‚ö†Ô∏è BAHAYA PETIR! Sebaiknya tunda melaut."; safetyIcon = "cloud-lightning"; safetyColor = "text-red-500"; }
            else if (wx.weathercode >= 51) { safetyMsg = "üåßÔ∏è Sedia jas hujan, basah kuyup nanti."; safetyIcon = "cloud-rain"; safetyColor = "text-blue-400"; }
            else if (wx.temperature > 30) { safetyMsg = "‚òÄÔ∏è Panas terik! Pakai sunblock & topi."; safetyIcon = "sun"; safetyColor = "text-orange-400"; }
            
            wayanPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-bl from-slate-900 via-slate-800 to-slate-900 -z-10"></div>
                    <div class="absolute bottom-0 left-0 w-full h-1/2 bg-gradient-to-t from-blue-900/10 to-transparent -z-10"></div>
                    <div class="text-center px-6 animate-in slide-in-from-right duration-500 relative z-10">
                        <div class="w-24 h-24 mx-auto mb-6 bg-neutral-800 rounded-full flex items-center justify-center border border-white/10">
                            <i data-lucide="${safetyIcon}" class="w-12 h-12 ${safetyColor}"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-4">Info Keselamatan</h2>
                        <p class="text-lg text-slate-300 leading-relaxed">${safetyMsg}</p>
                    </div>`
            });

            storiesData.push({
                title: 'Saran AI',
                color: 'from-blue-500 to-purple-500',
                img: 'https://api.dicebear.com/7.x/avataaars/svg?seed=Wayan',
                pages: wayanPages
            });

            // 2. Story: Aktivitas Ikan (Solunar - Donut Chart)
            const activityPages = [];
            let activity = 50;
            if (typeof SunCalc !== 'undefined') {
                const moon = SunCalc.getMoonIllumination(new Date());
                const phase = moon.phase; // 0.0 - 1.0
                // Full Moon (0.5) & New Moon (0.0/1.0) = High Activity
                if (phase < 0.1 || phase > 0.9) activity = 90; 
                else if (phase > 0.4 && phase < 0.6) activity = 100;
                else activity = 60;
            }
            
            // Page 1: Score
            activityPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-b from-indigo-950 via-slate-900 to-indigo-950 -z-10"></div>
                    <div class="absolute inset-0 opacity-20" style="background-image: radial-gradient(white 1px, transparent 1px); background-size: 20px 20px;"></div>
                    <div class="text-center animate-in zoom-in-90 duration-500 relative z-10">
                        <div class="relative w-56 h-56 mx-auto mb-8 flex items-center justify-center">
                            <svg class="w-full h-full transform -rotate-90"><circle cx="112" cy="112" r="100" stroke="currentColor" stroke-width="16" fill="transparent" class="text-slate-800" /><circle cx="112" cy="112" r="100" stroke="currentColor" stroke-width="16" fill="transparent" class="text-purple-500" stroke-dasharray="${2 * Math.PI * 100}" stroke-dashoffset="${2 * Math.PI * 100 * (1 - activity/100)}" style="transition: stroke-dashoffset 1.5s ease-out;" /></svg>
                            <div class="absolute inset-0 flex flex-col items-center justify-center"><span class="text-6xl font-black text-white">${activity}%</span><span class="text-sm text-purple-300 font-bold uppercase tracking-widest">Potensi</span></div>
                        </div>
                        <h2 class="text-3xl font-black text-white mb-2">Aktivitas Ikan</h2>
                        <p class="text-slate-300 text-lg">Fase bulan mendukung aktivitas <b>${activity > 80 ? 'TINGGI' : 'SEDANG'}</b> hari ini.</p>
                    </div>`
            });
            
            // Page 2: Tips
            activityPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-b from-indigo-950 via-purple-950 to-indigo-950 -z-10"></div>
                    <div class="absolute top-0 right-0 w-64 h-64 bg-purple-500/10 rounded-full blur-3xl -z-10"></div>
                    <div class="text-center px-6 animate-in slide-in-from-right duration-500 relative z-10">
                        <div class="w-24 h-24 mx-auto mb-6 bg-purple-900/30 rounded-full flex items-center justify-center border border-purple-500/30">
                            <i data-lucide="moon-star" class="w-12 h-12 text-purple-400"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-4">Tips Solunar</h2>
                        <p class="text-lg text-slate-300 leading-relaxed">
                            Waktu terbaik adalah saat bulan terbit atau terbenam. Cek tabel pasang surut untuk hasil maksimal.
                        </p>
                    </div>`
            });

            storiesData.push({
                title: 'Aktivitas',
                icon: 'activity',
                color: 'from-purple-600 to-pink-500',
                pages: activityPages
            });

            // 2. Story: Grafik Hujan (Bar Chart)
            const rainPages = [];
            const rainData = [];
            for(let i=0; i<8; i++) {
                const idx = new Date().getHours() + i;
                if(idx < hourly.time.length) rainData.push({ t: idx%24, p: hourly.precipitation_probability[idx] });
            }
            
            // Page 1: Chart
            rainPages.push({
                render: () => {
                    const bars = rainData.map(d => {
                        const h = Math.max(10, d.p * 2); // Scale height
                        const color = d.p > 50 ? 'bg-blue-400 shadow-[0_0_15px_rgba(96,165,250,0.8)]' : 'bg-slate-600';
                        return `
                            <div class="flex flex-col items-center gap-2 flex-1">
                                <div class="w-full rounded-t-lg ${color} transition-all duration-1000" style="height: ${h}px"></div>
                                <span class="text-xs font-bold text-blue-200/70">${d.t}:00</span>
                            </div>`;
                    }).join('');
                    
                    return `
                        <div class="absolute inset-0 bg-gradient-to-b from-slate-900 via-blue-950 to-slate-900 -z-10"></div>
                        <div class="absolute inset-0 opacity-5 bg-[linear-gradient(180deg,transparent_0%,rgba(255,255,255,0.2)_50%,transparent_100%)] bg-[length:4px_20px] -z-10"></div>
                        <div class="w-full max-w-sm px-4 animate-in slide-in-from-bottom-10 duration-500 relative z-10">
                            <h2 class="text-3xl font-black text-white mb-2 text-center drop-shadow-lg">Peluang Hujan</h2>
                            <p class="text-sm text-blue-200 text-center mb-10 font-medium">Prediksi 8 jam ke depan</p>
                            <div class="flex items-end justify-between h-64 gap-2 border-b border-white/10 pb-2">
                                ${bars}
                            </div>
                            <div class="mt-6 p-4 bg-black/30 backdrop-blur-md rounded-xl border border-white/10 text-center shadow-lg">
                                <p class="text-blue-100 text-sm font-bold">
                                    ${Math.max(...rainData.map(d=>d.p)) > 50 ? '‚ö†Ô∏è Sedia jas hujan, potensi hujan tinggi!' : '‚úÖ Cuaca cenderung kering.'}
                                </p>
                            </div>
                        </div>`;
                }
            });

            // Page 2: Summary
            const maxRain = Math.max(...rainData.map(d=>d.p));
            rainPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-b from-slate-900 via-blue-900 to-slate-900 -z-10"></div>
                    <div class="absolute inset-0 opacity-5 bg-[linear-gradient(180deg,transparent_0%,rgba(255,255,255,0.2)_50%,transparent_100%)] bg-[length:4px_20px] -z-10"></div>
                    <div class="text-center px-6 animate-in slide-in-from-right duration-500 relative z-10">
                        <div class="w-24 h-24 mx-auto mb-6 bg-blue-500/20 backdrop-blur-md rounded-full flex items-center justify-center border border-blue-400/30 shadow-[0_0_40px_rgba(59,130,246,0.4)]">
                            <i data-lucide="cloud-rain" class="w-12 h-12 text-blue-300"></i>
                        </div>
                        <h2 class="text-3xl font-bold text-white mb-4 drop-shadow-md">Ringkasan Hujan</h2>
                        <p class="text-lg text-blue-100 leading-relaxed font-medium">
                            ${maxRain > 50 ? 'Potensi hujan cukup tinggi dalam 8 jam ke depan.' : 'Langit diprediksi cukup bersahabat.'}
                            <br><br>
                            Peluang tertinggi: <b class="text-white text-2xl">${maxRain}%</b>
                        </p>
                    </div>`
            });

            storiesData.push({
                title: 'Hujan',
                icon: 'cloud-rain',
                color: 'from-blue-600 to-cyan-400',
                pages: rainPages
            });

            // 4. Story: Angin (Compass Visual)
            const windPages = [];
            windPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-br from-teal-950 via-emerald-950 to-teal-950 -z-10"></div>
                    <div class="absolute inset-0 opacity-10 bg-[linear-gradient(45deg,transparent_25%,rgba(255,255,255,0.1)_50%,transparent_75%,transparent_100%)] bg-[length:20px_20px] -z-10"></div>
                    <div class="text-center animate-in spin-in-12 duration-700 relative z-10">
                        <div class="relative w-64 h-64 mx-auto mb-8 flex items-center justify-center">
                            <!-- Compass Ring -->
                            <div class="absolute inset-0 rounded-full border-4 border-slate-700 border-dashed"></div>
                            <div class="absolute top-2 text-slate-500 font-black">U</div>
                            <div class="absolute bottom-2 text-slate-500 font-black">S</div>
                            <div class="absolute left-2 text-slate-500 font-black">B</div>
                            <div class="absolute right-2 text-slate-500 font-black">T</div>
                            
                            <!-- Arrow -->
                            <div class="transition-transform duration-1000" style="transform: rotate(${wx.winddirection}deg)">
                                <i data-lucide="arrow-up" class="w-32 h-32 text-emerald-400 fill-emerald-400/20 drop-shadow-[0_0_20px_rgba(52,211,153,0.6)]"></i>
                            </div>
                            
                            <!-- Speed Center -->
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-neutral-900/90 backdrop-blur-md w-24 h-24 rounded-full flex flex-col items-center justify-center border border-white/10 shadow-xl">
                                    <span class="text-3xl font-black text-white">${wx.windspeed}</span>
                                    <span class="text-[10px] text-slate-400 uppercase">km/h</span>
                                </div>
                            </div>
                        </div>
                        <h2 class="text-2xl font-bold text-white">Arah Angin</h2>
                        <p class="text-slate-400 mt-2">Angin berhembus dari arah <b>${wx.winddirection}¬∞</b></p>
                    </div>`
            });

            storiesData.push({
                title: 'Angin',
                icon: 'wind',
                color: 'from-emerald-500 to-teal-400',
                pages: windPages
            });

            // 5. Story: Ombak (Wave Animation) - Jika ada data laut
            if (typeof currentMarineData !== 'undefined' && currentMarineData && currentMarineData.hourly) {
                const wavePages = [];
                const waveH = currentMarineData.hourly.sea_level_height_msl ? currentMarineData.hourly.sea_level_height_msl[new Date().getHours()] : 0;
                // Simulasi tinggi ombak (karena data API kadang null, kita pakai dummy logic visual jika data kosong)
                const displayWave = waveH || (wx.windspeed / 10).toFixed(1); 
                
                wavePages.push({
                    render: () => `
                        <div class="absolute inset-0 bg-gradient-to-b from-cyan-950 via-blue-950 to-blue-900 -z-10"></div>
                        <div class="absolute inset-0 opacity-20 bg-[radial-gradient(circle_at_bottom,_var(--tw-gradient-stops))] from-blue-400/20 via-transparent to-transparent -z-10"></div>
                        <div class="text-center animate-in slide-in-from-bottom-10 duration-700 w-full relative z-10">
                            <div class="h-48 w-full relative overflow-hidden rounded-3xl bg-gradient-to-b from-sky-300 to-blue-600 mb-8 border-4 border-white/20 shadow-2xl">
                                <div class="absolute bottom-0 left-0 w-[200%] h-full flex animate-[wave_3s_linear_infinite]" style="transform: translateX(0);">
                                    <div class="w-1/2 h-full bg-blue-800/30" style="clip-path: polygon(0% 50%, 25% 45%, 50% 50%, 75% 55%, 100% 50%, 100% 100%, 0% 100%);"></div>
                                    <div class="w-1/2 h-full bg-blue-800/30" style="clip-path: polygon(0% 50%, 25% 45%, 50% 50%, 75% 55%, 100% 50%, 100% 100%, 0% 100%);"></div>
                                </div>
                                <div class="absolute inset-0 flex items-center justify-center flex-col">
                                    <span class="text-5xl font-black text-white drop-shadow-lg">${Math.abs(displayWave)}m</span>
                                    <span class="text-xs font-bold text-white/80 uppercase">Tinggi Ombak</span>
                                </div>
                            </div>
                            <h2 class="text-3xl font-bold text-white">Kondisi Laut</h2>
                            <p class="text-slate-300 mt-2">Ombak relatif ${displayWave > 1.5 ? 'TINGGI' : 'TENANG'}, ${displayWave > 1.5 ? 'hati-hati melaut!' : 'aman untuk perahu kecil.'}</p>
                        </div>
                        <style>@keyframes wave { 0% { transform: translateX(0); } 100% { transform: translateX(-50%); } }</style>`
                });

                storiesData.push({
                    title: 'Ombak',
                    icon: 'waves',
                    color: 'from-cyan-500 to-blue-600',
                    pages: wavePages
                });
            }

            // 6. Story: Suhu (Thermometer)
            const tempPages = [];
            tempPages.push({
                render: () => `
                    <div class="absolute inset-0 bg-gradient-to-br from-orange-950 via-red-950 to-orange-950 -z-10"></div>
                    <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full h-full bg-[radial-gradient(circle,_var(--tw-gradient-stops))] from-orange-500/10 via-transparent to-transparent -z-10"></div>
                    <div class="text-center animate-in zoom-in-90 duration-500 relative z-10">
                        <div class="text-[10rem] font-black text-white leading-none tracking-tighter drop-shadow-2xl">${Math.round(wx.temperature)}¬∞</div>
                        <p class="text-2xl font-bold text-orange-200 mt-4 uppercase tracking-widest">Temperatur</p>
                        <p class="text-slate-300 mt-2">Terasa seperti <b>${Math.round(wx.temperature + 2)}¬∞C</b> karena kelembaban.</p>
                    </div>`
            });

            storiesData.push({
                title: 'Suhu',
                icon: 'thermometer',
                color: 'from-orange-500 to-red-500',
                pages: tempPages
            });

            // Render Circles
            container.innerHTML = storiesData.map((s, i) => `
                <div class="flex flex-col items-center gap-1 shrink-0 cursor-pointer group" onclick="openStory(${i})">
                    <div class="w-[4.5rem] h-[4.5rem] rounded-full p-[3px] bg-gradient-to-tr from-yellow-400 via-red-500 to-purple-500 group-hover:scale-105 transition-transform shadow-lg">
                        <div class="w-full h-full rounded-full bg-black border-2 border-black flex items-center justify-center overflow-hidden relative">
                            ${s.img ? `<img src="${s.img}" class="w-full h-full object-cover">` : `<i data-lucide="${s.icon}" class="w-8 h-8 text-white"></i>`}
                        </div>
                    </div>
                    <span class="text-[10px] font-medium text-slate-300 group-hover:text-white transition-colors">${s.title}</span>
                </div>
            `).join('');
            
            lucide.createIcons();
        }

        // --- NEW: External Feed Post (Wikipedia & TheMealDB) ---
        // Cache memori untuk menyimpan data postingan eksternal agar tidak berubah-ubah saat re-render
        let externalPostDataCache = {};
        let fishWatchDataCache = null; // Cache untuk data FishWatch (agar tidak fetch ulang terus)
        let usedWikiKeywords = []; // Menyimpan kata kunci Wikipedia yang sudah ditampilkan agar tidak duplikat

        async function loadExternalFeedPost(containerId, mode = 'random') {
            const container = document.getElementById(containerId);
            if(!container) return;

            // 0. TAMPILKAN SKELETON LOADING (STRUKTUR HALAMAN)
            if (!externalPostDataCache[mode]) {
                container.innerHTML = FEED_SKELETON_HTML;
            }

            // 1. CEK CACHE: Jika data untuk mode ini sudah ada, pakai yang lama (biar tidak kedip/ganti konten)
            if (externalPostDataCache[mode]) {
                if (externalPostDataCache[mode] === 'loading') return; // Sedang loading, skip agar tidak double fetch
                renderExternalPostUI(container, externalPostDataCache[mode]);
                return;
            }

            externalPostDataCache[mode] = 'loading'; // Tandai sedang loading
            // Tentukan tipe konten berdasarkan mode
            let sourceType;
            if (mode === 'video') {
                // NEW: Fetch from Sheet (Source Type 8) - Video Komunitas
                sourceType = 8;
            } else if (mode === 'wiki') {
                sourceType = 1; // Force Wiki (Fallback)
            } else if (mode === 'mix') {
                // Random antara 0 (Resep), 1 (Wiki), atau 3 (Ensiklopedia)
                const types = [0, 1, 3];
                sourceType = types[Math.floor(Math.random() * types.length)];
            } else {
                const types = [0, 1, 3, 4, 5, 6, 7]; // Random semua (Tanpa Video Wikipedia & Arsip)
                sourceType = types[Math.floor(Math.random() * types.length)];
            }
            
            let postData = null;

            try {
                // --- SUMBER 1: TheMealDB (Resep Seafood) ---
                if (sourceType === 0) {
                    // Random: 70% Seafood Global, 30% Masakan Indonesia
                    const useIndo = Math.random() < 0.3;
                    let url = 'https://www.themealdb.com/api/json/v1/1/filter.php?c=Seafood';
                    let sourceLabel = "Resep Seafood";
                    
                    if (useIndo) {
                        url = 'https://www.themealdb.com/api/json/v1/1/filter.php?a=Indonesian';
                        sourceLabel = "Kuliner Nusantara";
                    }

                    const res = await fetch(url);
                    const data = await res.json();
                    const simpleMeal = data.meals[Math.floor(Math.random() * data.meals.length)];
                    
                    // Fetch Full Details untuk dapat Resep
                    const resDetail = await fetch(`https://www.themealdb.com/api/json/v1/1/lookup.php?i=${simpleMeal.idMeal}`);
                    const dataDetail = await resDetail.json();
                    const meal = dataDetail.meals[0];

                    let instructions = meal.strInstructions || "Resep tidak tersedia.";
                    // Format newline jadi <br>
                    instructions = instructions.replace(/\r\n/g, '<br>').replace(/\n/g, '<br>');

                    let captionHtml = `<b>${meal.strMeal}</b><br>${instructions}`;
                    
                    if (instructions.length > 120) {
                        const uniqueId = Math.random().toString(36).substr(2, 9);
                        const shortText = instructions.substring(0, 120) + "...";
                        
                        captionHtml = `<b>${meal.strMeal}</b><br>
                            <span id="short-${uniqueId}">
                                ${shortText} 
                                <span onclick="document.getElementById('short-${uniqueId}').classList.add('hidden'); document.getElementById('full-${uniqueId}').classList.remove('hidden');" class="text-slate-500 cursor-pointer font-bold hover:text-white text-xs">baca resep</span>
                            </span>
                            <span id="full-${uniqueId}" class="hidden animate-in fade-in text-xs text-slate-300 leading-relaxed">
                                <br>${instructions}
                            </span>`;
                    }
                    
                    postData = {
                        userName: "Chef Nelayan",
                        userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Chef",
                        location: "Dapur Umum",
                        image: meal.strMealThumb,
                        caption: captionHtml,
                        sourceName: sourceLabel,
                        likes: Math.floor(Math.random() * 500) + 100
                    };

                } else if (sourceType === 1) {
                    // --- SUMBER 2: Wikipedia (Fakta Ikan) ---
                    const keywords = [
                        // Ikan Laut & Tawar
                        "Ikan_badut", "Ikan_hiu", "Ikan_paus", "Ikan_pari", "Ikan_tuna", "Ikan_kakap", "Ikan_lele", "Ikan_nila", 
                        "Ikan_arwana", "Barakuda", "Marlin_biru", "Ikan_mas", "Ikan_tenggiri", "Ikan_tongkol", "Ikan_kerapu", 
                        "Ikan_kuwe", "Ikan_bawal", "Ikan_patin", "Ikan_gabus", "Ikan_belanak", "Ikan_mujair", "Ikan_gurami", 
                        "Ikan_layur", "Ikan_cakalang", "Ikan_teri", "Ikan_kembung", "Ikan_baronang", "Ikan_kakap_putih", 
                        "Ikan_kakap_merah", "Ikan_napoleon", "Ikan_buntal", "Ikan_sepat", "Ikan_betok", "Ikan_sidat", "Ikan_belida",
                        "Ikan_lemadang", "Ikan_layang", "Ikan_selar", "Ikan_ekor_kuning", "Ikan_manyung", "Ikan_sembilang",
                        // Biota Laut Lainnya
                        "Terumbu_karang", "Penyu", "Cumi-cumi", "Gurita", "Udang", "Kepiting", "Lobster", "Kuda_laut", 
                        "Ubur-ubur", "Bintang_laut", "Lumba-lumba", "Dugong", "Anjing_laut", "Singa_laut", "Walrus", 
                        "Paus_pembunuh", "Paus_biru", "Kerang", "Tiram", "Siput_laut", "Bulu_babi", "Teripang",
                        // Alat & Teknik Mancing
                        "Memancing", "Joran", "Kail", "Umpan_pancing", "Senar_pancing", "Reel_pancing", "Pelampung_(memancing)",
                        "Teknik_memancing", "Jigging", "Casting_(memancing)", "Trolling_(memancing)", "Fly_fishing", 
                        "Mancing_dasaran", "Popping_(memancing)", "Rawai", "Jala", "Bubu", "Rumpon",
                        // Lokasi & Ekosistem
                        "Laut", "Sungai", "Danau", "Rawa", "Waduk", "Muara", "Pantai", "Hutan_bakau", "Padang_lamun", 
                        "Palung_laut", "Samudra", "Teluk", "Selat", "Tanjung", "Delta_sungai",
                        // Destinasi Indonesia
                        "Danau_Toba", "Taman_Nasional_Bunaken", "Kepulauan_Raja_Ampat", "Taman_Nasional_Komodo", 
                        "Taman_Nasional_Wakatobi", "Kepulauan_Derawan", "Karimunjawa", "Nusa_Penida", "Gili_Trawangan",
                        "Laut_Banda", "Selat_Bali", "Teluk_Cenderawasih", "Pulau_Weh", "Taman_Nasional_Ujung_Kulon"
                    ];
                    
                    // Filter kata kunci yang belum dipakai
                    let availableKeywords = keywords.filter(k => !usedWikiKeywords.includes(k));
                    
                    // Jika semua sudah dipakai, reset list agar mulai dari awal lagi
                    if (availableKeywords.length === 0) {
                        usedWikiKeywords = [];
                        availableKeywords = keywords;
                    }
                    
                    const randomKey = availableKeywords[Math.floor(Math.random() * availableKeywords.length)];
                    usedWikiKeywords.push(randomKey); // Tandai sebagai sudah dipakai
                    
                    const res = await fetch(`https://id.wikipedia.org/api/rest_v1/page/summary/${randomKey}`);
                    const data = await res.json();

                    if (data.title && data.extract) {
                        const img = data.thumbnail ? data.thumbnail.source : 'https://cdn-icons-png.flaticon.com/512/1998/1998610.png';
                        
                        // Logic Truncate Text (Baca Selengkapnya) agar feed tidak kepanjangan
                        let captionHtml = `<b>${data.title}</b><br>${data.extract}`;
                        if (data.extract.length > 120) {
                            const uniqueId = Math.random().toString(36).substr(2, 9);
                            const shortText = data.extract.substring(0, 120) + "...";
                            
                            captionHtml = `<b>${data.title}</b><br>
                                <span id="short-${uniqueId}">
                                    ${shortText} 
                                    <span onclick="document.getElementById('short-${uniqueId}').classList.add('hidden'); document.getElementById('full-${uniqueId}').classList.remove('hidden');" class="text-slate-500 cursor-pointer font-bold hover:text-white text-xs">baca selengkapnya</span>
                                </span>
                                <span id="full-${uniqueId}" class="hidden animate-in fade-in">
                                    ${data.extract}
                                </span>`;
                        }

                        postData = {
                            userName: "Ensiklopedia Laut",
                            userAvatar: "https://upload.wikimedia.org/wikipedia/commons/6/63/Wikipedia-logo.png",
                            location: "Fakta Unik",
                            image: img,
                            caption: captionHtml,
                            sourceName: "Wikipedia",
                            likes: Math.floor(Math.random() * 200) + 50
                        };
                    }
                } else if (sourceType === 3) {
                    // --- SUMBER 4: FishWatch API (Ensiklopedia Ikan - No 1) ---
                    // Menggunakan CORS Proxy karena API ini kadang memblokir akses langsung dari browser
                    if (!fishWatchDataCache) {
                        try {
                            // Gunakan allorigins (JSON Wrapper) agar lebih stabil dan tidak error SyntaxError jika API down/HTML
                            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent('https://www.fishwatch.gov/api/species')}`);
                            if (!res.ok) throw new Error("Network response was not ok");
                            const wrapper = await res.json();
                            
                            if (wrapper && wrapper.contents) {
                                fishWatchDataCache = JSON.parse(wrapper.contents);
                            } else {
                                throw new Error("Invalid wrapper response");
                            }
                        } catch (e) {
                            console.warn("FishWatch API failed, fallback to Wiki", e);
                            delete externalPostDataCache[mode]; // Reset status loading agar tidak stuck
                            return loadExternalFeedPost(containerId, 'wiki'); // Fallback ke Wiki
                        }
                    }

                    if (fishWatchDataCache && Array.isArray(fishWatchDataCache) && fishWatchDataCache.length > 0) {
                        // Pilih ikan secara acak
                        const fish = fishWatchDataCache[Math.floor(Math.random() * fishWatchDataCache.length)];
                        
                        // Ekstrak Data (Bersihkan tag HTML yang mungkin terbawa)
                        const name = fish['Species Name'];
                        const sciName = fish['Scientific Name'];
                        const habitat = fish['Habitat'] ? fish['Habitat'].replace(/<[^>]*>?/gm, '').substring(0, 120) + '...' : 'Habitat laut.';
                        const desc = fish['Physical Description'] ? fish['Physical Description'].replace(/<[^>]*>?/gm, '').substring(0, 150) + '...' : 'Deskripsi tidak tersedia.';
                        
                        let imgUrl = 'https://cdn-icons-png.flaticon.com/512/1998/1998610.png';
                        if (fish['Image Gallery'] && fish['Image Gallery'][0] && fish['Image Gallery'][0].src) {
                            imgUrl = fish['Image Gallery'][0].src;
                        }

                        postData = {
                            userName: "Ahli Biologi Laut",
                            userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Professor",
                            location: "Ensiklopedia Ikan",
                            image: imgUrl,
                            caption: `<b>${name}</b> <i>(${sciName})</i><br><br>üß¨ <b>Fakta Biologis:</b><br>${desc}<br><br>üåä <b>Habitat:</b> ${habitat}`,
                            sourceName: "FishWatch NOAA",
                            likes: Math.floor(Math.random() * 300) + 100
                        };
                    }
                } else if (sourceType === 4) {
                    // --- SUMBER 5: NASA OCEAN (Laut & Air) ---
                    // Menggantikan Wikimedia yang kurang bagus
                    const keywords = [
                        "ocean", "coral reef", "sea life", "underwater", "jellyfish", "shark", "whale", "dolphin", "sea turtle", 
                        "pacific ocean", "atlantic ocean", "waves", "deep sea", "marine biology", "scuba", "reef", "tropical fish", 
                        "manta ray", "octopus", "seahorse", "kelp forest", "plankton", "shipwreck", "arctic ocean", "indian ocean", 
                        "southern ocean", "barrier reef", "mariana trench", "sea ice", "ice shelf", "ocean currents", "tides", 
                        "hydrothermal vent", "abyss", "coast", "shoreline", "estuary", "mangrove", "lagoon", "fjord", "atoll", "archipelago",
                        "marine life", "aquatic", "sea floor", "benthic", "pelagic", "coastal", "marine ecosystem", "oceanography", 
                        "sea exploration", "submersible", "rov", "marine sanctuary", "great blue hole", "sargasso sea", "bermuda triangle", 
                        "gulf stream", "tsunami", "tidal wave", "sea storm", "ocean sunset", "ocean sunrise", "bioluminescence", "red tide", 
                        "algae bloom", "coral bleaching", "marine pollution", "plastic ocean", "oil spill ocean", "sea birds", "penguin", 
                        "seal", "walrus", "polar bear swim", "otter", "manatee", "dugong", "orca", "sperm whale", "humpback whale", 
                        "blue whale", "narwhal", "beluga", "sea lion", "crustacean", "mollusk", "echinoderm", "sponge", "anemone"
                    ];
                    const keyword = keywords[Math.floor(Math.random() * keywords.length)];
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 6000);
                        const res = await fetch(`https://images-api.nasa.gov/search?q=${keyword}&media_type=video`, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await res.json();
                        
                        if (data.collection && data.collection.items && data.collection.items.length > 0) {
                            const items = data.collection.items;
                            const item = items[Math.floor(Math.random() * items.length)];
                            const meta = item.data[0];
                            const collectionUrl = item.href.replace("http:", "https:");
                            
                            const videoRes = await fetch(collectionUrl);
                            const videoFiles = await videoRes.json();
                            const mp4 = videoFiles.find(f => f.endsWith('~medium.mp4')) || videoFiles.find(f => f.endsWith('.mp4'));
                            const thumb = item.links ? item.links.find(l => l.rel === 'preview')?.href : '';

                            if (mp4) {
                                postData = {
                                    userName: "NatGeo Ocean",
                                    userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Ocean",
                                    location: "Samudra",
                                    videoFile: mp4.replace("http:", "https:"),
                                    thumbnail: thumb,
                                    caption: `<b>${meta.title}</b><br>${meta.description ? meta.description.substring(0, 120) + '...' : 'Keindahan laut dari arsip NASA.'}`,
                                    sourceName: "National Geographic",
                                    likes: Math.floor(Math.random() * 500) + 200
                                };
                            }
                        }
                    } catch(e) { console.warn("NASA Ocean failed", e); }
                } else if (sourceType === 5) {
                    // --- SUMBER 6: NASA SPACE (Luar Angkasa) ---
                    const keywords = [
                        "galaxy", "nebula", "planet", "sun", "moon", "mars", "jupiter", "saturn", "astronaut", "iss", "spacewalk", 
                        "solar flare", "black hole", "supernova", "milky way", "asteroid", "comet", "constellation", "hubble telescope", 
                        "james webb telescope", "space station", "launch", "rocket", "eclipse", "pluto", "venus", "mercury", "uranus", 
                        "neptune", "star cluster", "pulsar", "quasar", "earth orbit", "satellite view", "deep space", "exoplanet", 
                        "cosmic dust", "dark matter", "gravity", "spacex", "artemis", "orion", "voyager", "cassini", "juno", 
                        "perseverance", "curiosity rover", "international space station", "zero gravity", "cosmos", "universe", 
                        "astronomy", "astrophysics", "stargazing", "telescope view", "observatory", "radio telescope", "spitzer", 
                        "chandra", "kepler", "tess", "gaia", "rosetta", "new horizons", "dawn spacecraft", "osiris-rex", "hayabusa", 
                        "parker solar probe", "solar orbiter", "stereo spacecraft", "sdo", "soho", "goes satellite", "landsat", 
                        "sentinel satellite", "copernicus satellite", "galileo satellite", "gps satellite", "communication satellite", 
                        "space debris", "space junk", "reentry", "splashdown", "docking", "undocking", "soyuz", "progress spacecraft", 
                        "dragon capsule", "starliner", "dream chaser", "blue origin", "virgin galactic", "space tourism", "moon landing", 
                        "apollo", "gemini", "mercury program", "skylab", "mir space station", "salyut", "tiangong", "shenzhou", 
                        "gaganyaan", "chandrayaan", "mangalyaan", "hope mars mission", "emirates mars mission", "tianwen", 
                        "change moon mission", "luna moon mission", "viking mars", "mariner", "pioneer", "surveyor", "ranger", 
                        "magellan", "galileo jupiter", "ulysses", "near shoemaker", "deep impact", "stardust", "genesis", "messenger", 
                        "lro", "lcross", "grail", "ladee", "maven", "insight", "psyche", "lucy", "dart", "juice mission", 
                        "europa clipper", "dragonfly titan", "roman space telescope", "euclid", "plato", "ariel", "athena", "lisa", "gwst"
                    ];
                    const keyword = keywords[Math.floor(Math.random() * keywords.length)];
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 6000);
                        const res = await fetch(`https://images-api.nasa.gov/search?q=${keyword}&media_type=video`, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await res.json();
                        
                        if (data.collection && data.collection.items && data.collection.items.length > 0) {
                            const items = data.collection.items;
                            const item = items[Math.floor(Math.random() * items.length)];
                            const meta = item.data[0];
                            const collectionUrl = item.href.replace("http:", "https:");
                            
                            // Fetch actual video files
                            const videoRes = await fetch(collectionUrl);
                            const videoFiles = await videoRes.json();
                            const mp4 = videoFiles.find(f => f.endsWith('~medium.mp4')) || videoFiles.find(f => f.endsWith('.mp4'));
                                        
                            const thumb = item.links ? item.links.find(l => l.rel === 'preview')?.href : '';

                            if (mp4) {
                                postData = {
                                    userName: "NASA Space",
                                    userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Space",
                                    location: "Luar Angkasa",
                                    videoFile: mp4.replace("http:", "https:"),
                                    thumbnail: thumb,
                                    caption: `<b>${meta.title}</b><br>${meta.description ? meta.description.substring(0, 120) + '...' : 'Video luar angkasa NASA.'}`,
                                    sourceName: "NASA TV",
                                    likes: Math.floor(Math.random() * 500) + 200
                                };
                            }
                        }
                    } catch(e) { console.warn("NASA API failed", e); }
                } else if (sourceType === 6) {
                    // --- SUMBER 7: NASA EARTH (Pemandangan Bumi) ---
                    // Menggantikan Internet Archive yang "ngaco"
                    const keywords = [
                        "earth from space", "earth view", "blue marble", "atmosphere", "clouds from space", "island from space", 
                        "coastline space", "river delta space", "desert from space", "forest from space", "city lights space", 
                        "glacier melt", "deforestation", "amazon rainforest", "sahara desert", "himalayas", "grand canyon", 
                        "great barrier reef", "nile river", "andes mountains", "earth timelapse", "night lights", "weather satellite", 
                        "hurricane from space", "typhoon from space", "volcano from space", "earth horizon", "sunrise from space", 
                        "sunset from space", "aurora from space", "lightning from space", "earth curvature", "earth observation", 
                        "remote sensing", "satellite imagery", "aerial photography", "geography", "geology", "topography", "cartography", 
                        "biosphere", "hydrosphere", "lithosphere", "cryosphere", "climate change", "global warming", "greenhouse effect", 
                        "carbon cycle", "water cycle", "nitrogen cycle", "ozone layer", "stratosphere", "mesosphere", "thermosphere", 
                        "exosphere", "ionosphere", "magnetosphere", "van allen belts", "geomagnetic storm", "space weather", "solar wind", 
                        "coronal mass ejection", "aurora australis", "southern lights", "airglow", "noctilucent clouds", 
                        "polar mesospheric clouds", "nacreous clouds", "contrails", "ship tracks", "dust storm", "haze", "smoke", 
                        "volcanic ash", "pyrocumulonimbus", "urban heat island", "light pollution", "agriculture from space", 
                        "irrigation from space", "mining from space", "urban sprawl", "infrastructure from space", "roads from space", 
                        "bridges from space", "dams from space", "canals from space", "ports from space", "airports from space"
                    ];
                    const keyword = keywords[Math.floor(Math.random() * keywords.length)];
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 6000);
                        const res = await fetch(`https://images-api.nasa.gov/search?q=${keyword}&media_type=video`, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await res.json();
                        
                        if (data.collection && data.collection.items && data.collection.items.length > 0) {
                            const items = data.collection.items;
                            const item = items[Math.floor(Math.random() * items.length)];
                            const meta = item.data[0];
                            const collectionUrl = item.href.replace("http:", "https:");
                            
                            const videoRes = await fetch(collectionUrl);
                            const videoFiles = await videoRes.json();
                            const mp4 = videoFiles.find(f => f.endsWith('~medium.mp4')) || videoFiles.find(f => f.endsWith('.mp4'));
                            const thumb = item.links ? item.links.find(l => l.rel === 'preview')?.href : '';

                            if (mp4) {
                                postData = {
                                    userName: "NASA Earth",
                                    userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Earth",
                                    location: "Orbit Bumi",
                                    videoFile: mp4.replace("http:", "https:"),
                                    thumbnail: thumb,
                                    caption: `<b>${meta.title}</b><br>${meta.description ? meta.description.substring(0, 120) + '...' : 'Pemandangan Bumi dari angkasa.'}`,
                                    sourceName: "NASA",
                                    likes: Math.floor(Math.random() * 600) + 300
                                };
                            }
                        }
                    } catch(e) { console.warn("NASA Earth failed", e); }
                } else if (sourceType === 7) {
                    // --- SUMBER 8: NASA NATURE (Fenomena Alam) ---
                    // Menggantikan Pure Nature (Wikimedia)
                    const keywords = [
                        "aurora borealis", "northern lights", "hurricane", "storm", "volcano", "glacier", "iceberg", "lightning", 
                        "tornado", "river", "mountain", "thunderstorm", "blizzard", "sandstorm", "monsoon", "typhoon", "cyclone", 
                        "rainforest", "waterfall", "canyon", "cave", "cliff", "valley", "savanna", "tundra", "wildfire", "flood", 
                        "drought", "eruption", "lava", "geyser", "national park", "wilderness", "landscape", "scenery", "sunset", 
                        "sunrise", "cloud formation", "fog", "mist", "rainbow", "seascape", "desert landscape", "mountain range", 
                        "forest aerial", "jungle aerial", "river aerial", "ecology", "biodiversity", "conservation", "habitat", 
                        "ecosystem", "biome", "flora", "fauna", "vegetation", "wildlife", "animal behavior", "migration", "predation", 
                        "symbiosis", "parasitism", "mutualism", "commensalism", "evolution", "adaptation", "natural selection", 
                        "extinction", "endangered species", "invasive species", "pollution", "climate", "weather", "meteorology", 
                        "seasons", "spring", "summer", "autumn", "winter", "solstice", "equinox", "day", "night", "twilight", "dawn", 
                        "dusk", "cloud types", "cumulus", "stratus", "cirrus", "nimbus", "fog types", "radiation fog", "advection fog", 
                        "upslope fog", "evaporation fog", "precipitation", "rain", "snow", "hail", "sleet", "graupel", "dew", "frost", 
                        "ice", "glaciation", "erosion", "weathering", "sedimentation", "deposition", "tectonics", "plate tectonics", 
                        "earthquake", "seismology", "volcanology", "mineralogy", "petrology", "paleontology", "fossil", "dinosaur", 
                        "prehistoric life"
                    ];
                    const keyword = keywords[Math.floor(Math.random() * keywords.length)];
                    
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 6000);
                        const res = await fetch(`https://images-api.nasa.gov/search?q=${keyword}&media_type=video`, { signal: controller.signal });
                        clearTimeout(timeoutId);
                        const data = await res.json();
                        
                        if (data.collection && data.collection.items && data.collection.items.length > 0) {
                            const items = data.collection.items;
                            const item = items[Math.floor(Math.random() * items.length)];
                            const meta = item.data[0];
                            const collectionUrl = item.href.replace("http:", "https:");
                            
                            const videoRes = await fetch(collectionUrl);
                            const videoFiles = await videoRes.json();
                            const mp4 = videoFiles.find(f => f.endsWith('~medium.mp4')) || videoFiles.find(f => f.endsWith('.mp4'));
                            const thumb = item.links ? item.links.find(l => l.rel === 'preview')?.href : '';

                            if (mp4) {
                                postData = {
                                    userName: "NatGeo Wild",
                                    userAvatar: "https://api.dicebear.com/7.x/avataaars/svg?seed=Nature",
                                    location: "Fenomena Alam",
                                    videoFile: mp4.replace("http:", "https:"),
                                    thumbnail: thumb,
                                    caption: `<b>${meta.title}</b><br>${meta.description ? meta.description.substring(0, 120) + '...' : 'Fenomena alam dari arsip NASA.'}`,
                                    sourceName: "National Geographic",
                                    likes: Math.floor(Math.random() * 400) + 150
                                };
                            }
                        }
                    } catch(e) { console.warn("NASA Nature failed", e); }
                } else if (sourceType === 8) {
                    // --- SUMBER 9: Google Sheet Video (Community Reels) ---
                    let videos = [];
                    try {
                        const cached = JSON.parse(localStorage.getItem('feed_cache') || '{}');
                        videos = cached.videos || [];
                    } catch (e) {}

                    if (videos.length === 0) {
                        try {
                            const SHEET_URL = (typeof GOOGLE_SCRIPT_URL !== 'undefined') ? GOOGLE_SCRIPT_URL : "https://script.google.com/macros/s/AKfycbybJe6cBuciSnj4j4hmm3nN4C860Sen9RVht6b1O5cZoRpkwvBoDLw6jTkYa4tmUas1/exec";
                            const res = await fetch(`${SHEET_URL}?type=all&t=${Date.now()}`);
                            const data = await res.json();
                            if (data && data.videos) videos = data.videos;
                        } catch(e) {}
                    }
                    
                    if (videos.length > 0) {
                        const item = videos[Math.floor(Math.random() * videos.length)];
                        if (item.video) {
                             postData = {
                                userName: item.name || item.user || "Member Komunitas",
                                userAvatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${item.name || 'User'}`,
                                location: "Reels Komunitas",
                                videoFile: item.video,
                                thumbnail: '', 
                                caption: `<b>${item.caption || 'Video Komunitas'}</b>`,
                                sourceName: "Komunitas",
                                likes: Math.floor(Math.random() * 100) + 10
                            };
                        }
                    }
                }

                // 2. SIMPAN KE CACHE & RENDER
                if (postData) {
                    externalPostDataCache[mode] = postData; // Simpan ke cache agar render berikutnya (Network) pakai data yang sama
                    // Re-query container karena elemen DOM mungkin sudah diganti oleh render ulang
                    const currentContainer = document.getElementById(containerId);
                    if(currentContainer) renderExternalPostUI(currentContainer, postData, mode);
                } else {
                    delete externalPostDataCache[mode]; // Hapus status loading jika gagal
                    
                    // --- AUTO RETRY LOGIC ---
                    // Jika gagal load (timeout/kosong), coba lagi otomatis setelah 500ms
                    console.log("Konten eksternal gagal/timeout, mencoba sumber lain...");
                    setTimeout(() => loadExternalFeedPost(containerId, mode), 500);
                }
            } catch (e) {
                console.warn("Gagal load external post", e);
                container.style.display = 'none';
                
                // Retry juga saat error catch (misal network error)
                delete externalPostDataCache[mode];
                setTimeout(() => loadExternalFeedPost(containerId, mode), 1000);
            }
        }

        // Helper: Toggle Video Play/Pause (TikTok Style)
        window.toggleVideo = function(container) {
            const video = container.querySelector('video');
            const icon = container.querySelector('.play-icon');
            const spinner = container.querySelector('.loading-spinner');
            
            if (!video) return;

            if (video.paused) {
                if(spinner) spinner.classList.remove('hidden'); // Show spinner while loading
                video.muted = false; // Pastikan suara menyala saat play
                const playPromise = video.play();
                if (playPromise !== undefined) {
                    playPromise
                        .then(() => { icon.classList.add('opacity-0', 'scale-150'); if(spinner) spinner.classList.add('hidden'); })
                        .catch(e => { 
                            console.error("Play error", e); 
                            if(spinner) spinner.classList.add('hidden');
                            // FIX: Auto refresh dimatikan agar user bisa memilih sendiri
                            // Biarkan user menekan tombol refresh manual jika video error
                        });
                }
            } else {
                video.pause();
                icon.classList.remove('opacity-0', 'scale-150'); // Muncul kembali
            }
        }

        // Helper: Refresh Video (Ganti Video Baru)
        window.refreshVideo = function(containerId) {
            const container = document.getElementById(containerId);
            if(container) {
                const btn = container.querySelector('.refresh-btn i');
                if(btn) btn.classList.add('animate-spin'); // Visual feedback
                delete externalPostDataCache['video']; 
                delete externalPostDataCache['mix']; // Clear mix too just in case
                loadExternalFeedPost(containerId, 'video'); // Load baru
            }
        }

        // Helper: Render Tampilan Postingan (Sama persis dengan Feed User)
        function renderExternalPostUI(container, d, mode) {
            // Verified Badge Logic
            const isVerified = ['Wayan', 'StoryBali', 'Kapten Jack', 'NatGeo', 'NASA', 'Ensiklopedia', 'Chef', 'Ahli'].some(k => d.userName.includes(k)) || (d.videoFile || d.videoUrl);
            const verifiedBadge = `<svg class="w-4 h-4 ml-1" viewBox="0 0 24 24" fill="none"><path d="M23 12l-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.69L1 12l2.44 2.79-.34 3.69 3.61.82 1.89 3.2 3.4-1.46 3.4 1.46 1.89-3.2 3.61-.82-.34-3.69L23 12z" fill="#3b82f6"/><path d="M10 15.17L6.12 11.29L7.53 9.87L10 12.34L16.47 5.87L17.88 7.29L10 15.17Z" fill="black"/></svg>`;

            container.className = "bg-black mb-1 pb-2 border-b border-neutral-800 cv-auto";
            container.innerHTML = `
                <!-- Header -->
                <div class="flex items-center justify-between px-3 py-2.5 animate-in fade-in duration-500">
                    <div class="flex items-center gap-2.5">
                        <div class="w-8 h-8 rounded-full p-[1.5px] bg-gradient-to-tr from-blue-400 to-emerald-400">
                            <div class="w-full h-full rounded-full border border-black overflow-hidden bg-white">
                            <img src="${d.userAvatar}" loading="lazy" class="w-full h-full object-contain">
                        </div>
                    </div>
                    <div>
                        <div class="flex items-center gap-1">
                            <p class="text-sm font-semibold text-white truncate">${d.userName}</p>
                            ${isVerified ? verifiedBadge : ''}
                        </div>
                        <p class="text-xs text-white/80 font-medium">${d.location}</p>
                    </div>
                </div>
                <button class="text-white"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
            </div>

                <!-- Media (Video or Image) -->
                <div class="w-full bg-neutral-900 relative group overflow-hidden" ondblclick="handleDoubleTapLike('${container.id}', this)">
                    ${d.videoUrl ? 
                        `<div class="aspect-[4/5] w-full"><iframe src="${d.videoUrl}" loading="lazy" class="w-full h-full border-0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div>` 
                        : (d.videoFile ? 
                            `<div class="aspect-[4/5] w-full flex items-center justify-center bg-black relative cursor-pointer overflow-hidden" onclick="openReelFromFeed('${mode}', this)">
                                <video src="${d.videoFile}" poster="${d.thumbnail || ''}" class="w-full h-full object-cover feed-video" playsinline loop crossorigin="anonymous" preload="metadata" muted onwaiting="this.parentElement.querySelector('.loading-spinner')?.classList.remove('hidden')" onplaying="this.parentElement.querySelector('.loading-spinner')?.classList.add('hidden')" onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full text-slate-500 text-xs\\'>Video tidak tersedia</div>'"></video>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div class="loading-spinner hidden absolute"><i data-lucide="loader" class="w-10 h-10 text-white animate-spin"></i></div>
                                </div>
                                <!-- NEW: Mute Button -->
                                <button onclick="event.stopPropagation(); toggleMute(this)" class="absolute bottom-3 right-3 z-20 bg-black/40 hover:bg-black/60 text-white p-2 rounded-full backdrop-blur-md transition-all border border-white/10">
                                    <i data-lucide="volume-x" class="w-5 h-5"></i>
                                </button>
                             </div>`
                            : `<img src="${d.image}" class="w-full h-auto max-h-[600px] object-cover min-h-[300px]" loading="lazy">`
                        )
                    }
                    
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none z-20">
                        <i data-lucide="heart" class="w-24 h-24 text-white fill-white opacity-0 transform scale-0 transition-all duration-300 double-tap-heart drop-shadow-2xl"></i>
                    </div>
                </div>

                <!-- Actions & Caption -->
                <div class="px-3 pt-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-4">
                            <button onclick="handleLike('${container.id}', this)" class="text-white hover:text-white/70 transition-colors"><i data-lucide="heart" class="w-6 h-6 ${isPostLiked(container.id) ? 'fill-red-500 text-red-500' : ''}"></i></button>
                            <button class="text-white hover:text-white/70 transition-colors"><i data-lucide="message-circle" class="w-6 h-6 -rotate-90"></i></button>
                            <button class="text-white hover:text-white/70 transition-colors"><i data-lucide="send" class="w-6 h-6"></i></button>
                        </div>
                        <button onclick="alert('Fitur simpan untuk postingan eksternal akan segera hadir!')" class="text-white hover:text-white/70 transition-colors">
                            <i data-lucide="bookmark" class="w-6 h-6"></i>
                        </button>
                    </div>
                    
                    <p class="text-sm font-semibold text-white mb-1">${d.likes} suka</p>
                    
                    <div class="text-sm text-white leading-snug mb-1">
                        <span class="font-semibold mr-1">${d.userName}</span>
                        <span id="caption-${container.id}">${d.caption}</span>
                    </div>
                    <button onclick="translateCaption(this, 'caption-${container.id}')" class="text-[10px] font-bold text-slate-500 hover:text-white mb-2 cursor-pointer">Terjemahkan</button>
                    
                    <p class="text-[10px] text-neutral-500 uppercase tracking-wide mt-2">Disponsori ‚Ä¢ Baru saja</p>
                </div>
            `;
            
            // Observe video if exists (Lazy Play)
            const vid = container.querySelector('video.feed-video');
            if(vid && window.feedVideoObserver) window.feedVideoObserver.observe(vid);
            
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        function openStory(index, startPage = 0) {
            currentStoryIndex = index;
            currentStoryPageIndex = startPage;
            const modal = document.getElementById('storyViewerModal');
            modal.classList.remove('hidden');
            
            // Render Progress Bars Container
            const group = storiesData[currentStoryIndex];
            const barsContainer = document.getElementById('story-bars-container');
            barsContainer.innerHTML = group.pages.map((_, i) => `
                <div class="h-1 flex-1 bg-white/30 rounded-full overflow-hidden">
                    <div id="story-bar-${i}" class="h-full bg-white w-0"></div>
                </div>
            `).join('');
            
            renderStoryContent();
        }

        function renderStoryContent() {
            const group = storiesData[currentStoryIndex];
            const page = group.pages[currentStoryPageIndex];
            const content = document.getElementById('story-content');
            
            // Render Content
            content.innerHTML = page.render();
            document.getElementById('story-header-title').innerText = group.title;
            lucide.createIcons();

            // Reset Bars Visual
            group.pages.forEach((_, i) => {
                const bar = document.getElementById(`story-bar-${i}`);
                if(bar) {
                    if (i < currentStoryPageIndex) bar.style.width = '100%';
                    else if (i > currentStoryPageIndex) bar.style.width = '0%';
                    else bar.style.width = '0%';
                }
            });

            startStoryProgress();
        }

        function startStoryProgress() {
            clearInterval(storyInterval);
            storyProgress = 0;
            isStoryPaused = false;
            
            const bar = document.getElementById(`story-bar-${currentStoryPageIndex}`);
            const duration = 5000; // 5 detik per story
            const step = 20; // Update tiap 20ms
            const increment = (step / duration) * 100;

            storyInterval = setInterval(() => {
                if (!isStoryPaused) {
                    storyProgress += increment;
                    if (bar) bar.style.width = `${Math.min(storyProgress, 100)}%`;
                    
                    if (storyProgress >= 100) {
                        nextStory();
                    }
                }
            }, step);
        }

        let lastStoryInteraction = 0;

        // Handle Touch/Click Logic (Pause & Navigation)
        function handleStoryTouch(action, direction, event) {
            // Prevent ghost clicks from touch events (Double firing fix)
            if (event) {
                if (event.type.startsWith('touch')) {
                    lastStoryInteraction = Date.now();
                } else if (event.type.startsWith('mouse') && (Date.now() - lastStoryInteraction < 500)) {
                    // Ignore mouse event if touch happened recently
                    return;
                }
            }

            if (action === 'start') {
                isStoryPaused = true;
                storyTouchStartTime = Date.now();
            } else if (action === 'end') {
                isStoryPaused = false;
                
                const duration = Date.now() - storyTouchStartTime;
                if (duration < 200) { // Jika tap cepat (<200ms), anggap navigasi
                    if (direction === 'next') nextStory();
                    else prevStory();
                }
            }
        }

        function prevStory() {
            if (currentStoryPageIndex > 0) {
                currentStoryPageIndex--;
                renderStoryContent();
            } else {
                if (currentStoryIndex > 0) {
                    // Go to previous group, last page
                    openStory(currentStoryIndex - 1, storiesData[currentStoryIndex - 1].pages.length - 1);
                } else {
                    renderStoryContent(); // Restart current
                }
            }
        }

        function nextStory() {
            const group = storiesData[currentStoryIndex];
            if (currentStoryPageIndex < group.pages.length - 1) {
                currentStoryPageIndex++;
                renderStoryContent();
            } else if (currentStoryIndex < storiesData.length - 1) {
                openStory(currentStoryIndex + 1);
            } else {
                closeStoryViewer();
            }
        }

        function closeStoryViewer() {
            document.getElementById('storyViewerModal').classList.add('hidden');
            clearInterval(storyInterval);
        }

        // --- NEW: SOCIAL FEATURES (Like, Comment, Share) ---
        
        // 1. Cek apakah user sudah like post ini (Local Storage)
        function isPostLiked(postId) {
            return localStorage.getItem('liked_' + postId) === 'true';
        }

        // 1.5 Cek apakah user sudah save post ini (Berdasarkan Lokasi)
        function isPostSaved(lat, lng) {
            const favs = JSON.parse(localStorage.getItem('favorites') || '[]');
            return favs.some(f => parseFloat(f.lat).toFixed(5) === parseFloat(lat).toFixed(5) && parseFloat(f.lng).toFixed(5) === parseFloat(lng).toFixed(5));
        }

        // 2. Handle Like
        function handleLike(postId, btnElement) {
            if (isPostLiked(postId)) {
                // Opsional: Bisa tambah logika Unlike disini, tapi untuk sekarang kita batasi 1 like
                const icon = btnElement.querySelector('svg');
                icon.classList.add('animate-shake'); // Efek getar kalau sudah like
                setTimeout(() => icon.classList.remove('animate-shake'), 500);
                return; 
            }

            // Optimistic UI Update (Langsung merah & nambah angka sebelum request selesai)
            const icon = btnElement.querySelector('svg'); // Lucide render svg inside button
            if(icon) {
                icon.classList.add('fill-red-500', 'text-red-500', 'scale-125');
                setTimeout(() => icon.classList.remove('scale-125'), 200);
            }
            
            const countEl = document.getElementById('likes-count-' + postId);
            if(countEl) countEl.innerText = parseInt(countEl.innerText) + 1;

            // Simpan status di LocalStorage
            localStorage.setItem('liked_' + postId, 'true');

            // Kirim ke Google Sheet
            const SHEET_URL = (typeof GOOGLE_SCRIPT_URL !== 'undefined') ? GOOGLE_SCRIPT_URL : "https://script.google.com/macros/s/AKfycbybJe6cBuciSnj4j4hmm3nN4C860Sen9RVht6b1O5cZoRpkwvBoDLw6jTkYa4tmUas1/exec";
            
            fetch(SHEET_URL, {
                method: 'POST',
                mode: 'no-cors', // Penting untuk GAS
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'like', id: postId })
            }).catch(err => console.error("Gagal kirim like", err));
        }

        // 2.5 Handle Double Tap Like (Instagram Style)
        window.handleDoubleTapLike = function(postId, container) {
            // 1. Trigger Animation (Big Heart Center)
            const heartIcon = container.querySelector('.double-tap-heart');
            if (heartIcon) {
                if (heartIcon.dataset.timeoutId) clearTimeout(parseInt(heartIcon.dataset.timeoutId));
                
                // Reset animation state
                heartIcon.classList.remove('transition-all', 'duration-300');
                heartIcon.classList.add('opacity-0', 'scale-0');
                heartIcon.classList.remove('opacity-100', 'scale-110');
                void heartIcon.offsetWidth; // Force reflow
                
                // Animate In
                heartIcon.classList.add('transition-all', 'duration-300');
                heartIcon.classList.remove('opacity-0', 'scale-0');
                heartIcon.classList.add('opacity-100', 'scale-110');
                
                const id = setTimeout(() => {
                    heartIcon.classList.remove('opacity-100', 'scale-110');
                    heartIcon.classList.add('opacity-0', 'scale-0');
                }, 800);
                heartIcon.dataset.timeoutId = id;
            }

            // 2. Flying Heart Animation (New Feature)
            const postDiv = container.parentElement;
            let likeBtn = postDiv ? postDiv.querySelector(`button[onclick*="handleLike('${postId}'"]`) : null;
            
            // Fallback: Try finding any button with a heart icon if specific one not found
            if (!likeBtn && postDiv) {
                const heartIcon = postDiv.querySelector('button i[data-lucide="heart"]');
                if (heartIcon) likeBtn = heartIcon.closest('button');
            }
            
            if (likeBtn) {
                const rectContainer = container.getBoundingClientRect();
                const rectTarget = likeBtn.getBoundingClientRect();
                
                // Create flying element
                const flyer = document.createElement('div');
                flyer.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 24 24" fill="#ef4444" stroke="#ef4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>';
                flyer.className = 'fixed z-[9999] pointer-events-none transition-all duration-700 ease-in-out';
                
                const size = 80; 
                flyer.style.width = `${size}px`;
                flyer.style.height = `${size}px`;
                
                const startLeft = rectContainer.left + (rectContainer.width / 2) - (size / 2);
                const startTop = rectContainer.top + (rectContainer.height / 2) - (size / 2);
                
                flyer.style.left = `${startLeft}px`;
                flyer.style.top = `${startTop}px`;
                flyer.style.transform = 'scale(0)';
                flyer.style.opacity = '0';
                
                document.body.appendChild(flyer);

                requestAnimationFrame(() => {
                    flyer.style.transform = 'scale(1)';
                    flyer.style.opacity = '1';
                    
                    setTimeout(() => {
                        const targetLeft = rectTarget.left + (rectTarget.width / 2) - (size / 2);
                        const targetTop = rectTarget.top + (rectTarget.height / 2) - (size / 2);
                        
                        flyer.style.left = `${targetLeft}px`;
                        flyer.style.top = `${targetTop}px`;
                        flyer.style.transform = 'scale(0.2)';
                        flyer.style.opacity = '0.5';
                        
                        setTimeout(() => {
                            flyer.remove();
                            const btnIcon = likeBtn.querySelector('svg');
                            if(btnIcon) {
                                btnIcon.classList.add('animate-shake');
                                setTimeout(() => btnIcon.classList.remove('animate-shake'), 500);
                            }
                        }, 700);
                    }, 100);
                });
            }

            // 3. Logic Like (Only if not liked yet)
            if (!isPostLiked(postId)) {
                if (likeBtn) {
                    const onclickAttr = likeBtn.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes('handleLike')) {
                        handleLike(postId, likeBtn);
                    } else likeBtn.click();
                }
            }
        };

        // 3. Handle Share
        function handleShare(title, text, url) {
            if (navigator.share) {
                navigator.share({
                    title: 'Fishing Spot: ' + title,
                    text: text || 'Cek spot mancing keren ini!',
                    url: window.location.href // Share link web app
                }).catch(console.error);
            } else {
                // Fallback: Copy Link
                navigator.clipboard.writeText(window.location.href);
                alert("Link disalin ke clipboard!");
            }
        }

        // 4.1 Toggle Comments List (Show/Hide existing comments)
        function toggleCommentsList(postId) {
            const list = document.getElementById(`comments-list-${postId}`);
            if(list) list.classList.toggle('hidden');
        }

        // 4. Toggle Comment Section
        function toggleCommentSection(postId) {
            const section = document.getElementById(`comment-section-${postId}`);
            const input = document.getElementById(`comment-input-${postId}`);
            if (section) {
                section.classList.toggle('hidden');
                if (!section.classList.contains('hidden') && input) setTimeout(() => input.focus(), 100);
            }
        }

        // 5. Submit Comment (Inline)
        function submitComment(postId) {
            let userName = localStorage.getItem('guest_name');
            if (!userName) {
                userName = prompt("Masukkan nama panggilan Anda untuk berkomentar:");
                if (userName) localStorage.setItem('guest_name', userName);
                else return;
            }
            
            const input = document.getElementById(`comment-input-${postId}`);
            const text = input.value.trim();
            if (!text) return;
            
            input.value = ''; // Clear input immediately

            // Kirim ke Google Sheet
            const SHEET_URL = (typeof GOOGLE_SCRIPT_URL !== 'undefined') ? GOOGLE_SCRIPT_URL : "https://script.google.com/macros/s/AKfycbybJe6cBuciSnj4j4hmm3nN4C860Sen9RVht6b1O5cZoRpkwvBoDLw6jTkYa4tmUas1/exec";
            
            // Tampilkan feedback visual
            const toast = document.createElement('div');
            toast.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-blue-600 text-white px-4 py-2 rounded-full text-xs font-bold shadow-xl z-[3000] animate-bounce";
            toast.innerText = "Mengirim komentar...";
            document.body.appendChild(toast);

            fetch(SHEET_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'comment',
                    postId: postId,
                    userName: userName,
                    userAvatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${userName}`,
                    text: text
                })
            }).then(() => {
                toast.innerText = "Komentar terkirim!";
                setTimeout(() => toast.remove(), 2000);
                // Refresh Feed agar komentar muncul
                loadHomeFeed();
            }).catch(() => {
                toast.innerText = "Gagal mengirim.";
                setTimeout(() => toast.remove(), 2000);
            });
        }

        // 6. Handle Save Post (Bookmark)
        function handleSavePost(postId, btnElement) {
            // Cari data post dari Cache
            let postData = null;
            try {
                const cached = JSON.parse(localStorage.getItem('feed_cache') || '{}');
                const spots = Array.isArray(cached) ? cached : (cached.spots || []);
                const foundItem = spots.find(item => item.id === postId);
                if (foundItem) postData = foundItem;
            } catch(e) {}

            // Fallback: Cek di Global Grouped Spots
            if (!postData && typeof groupedSpots !== 'undefined') {
                for (const key in groupedSpots) {
                    const found = groupedSpots[key].find(s => s.id === postId);
                    if (found) { postData = found; break; }
                }
            }

            if (!postData) {
                alert("Gagal menyimpan: Data tidak ditemukan.");
                return;
            }

            // Format data untuk favorites (Pastikan koordinat berupa angka)
            const latVal = (typeof postData.lat === 'string') ? parseFloat(postData.lat.replace(',', '.')) : postData.lat;
            const lngVal = (typeof postData.lng === 'string') ? parseFloat(postData.lng.replace(',', '.')) : postData.lng;

            const favItem = {
                name: postData.name || 'Spot Mancing',
                lat: latVal,
                lng: lngVal,
                photo: postData.photo || '',
                comment: postData.comment || ''
            };

            // Simpan ke LocalStorage 'favorites'
            let favs = JSON.parse(localStorage.getItem('favorites') || '[]');
            const existingIndex = favs.findIndex(f => parseFloat(f.lat).toFixed(5) === parseFloat(favItem.lat).toFixed(5) && parseFloat(f.lng).toFixed(5) === parseFloat(favItem.lng).toFixed(5));
            
            let isSaved = false;
            if (existingIndex >= 0) {
                favs.splice(existingIndex, 1); // Hapus jika sudah ada
            } else {
                favs.push(favItem); // Tambah jika belum ada
                isSaved = true;
            }
            localStorage.setItem('favorites', JSON.stringify(favs));

            // Update UI Icon & Toast
            const icon = btnElement.querySelector('svg');
            if(icon) {
                if (isSaved) {
                    icon.classList.add('fill-yellow-400', 'text-yellow-400', 'animate-shake');
                    setTimeout(() => icon.classList.remove('animate-shake'), 500);
                } else {
                    icon.classList.remove('fill-yellow-400', 'text-yellow-400');
                }
            }
            
            const toast = document.createElement('div');
            toast.className = "fixed top-24 left-1/2 -translate-x-1/2 bg-neutral-900 text-white px-4 py-2 rounded-full text-xs font-bold shadow-xl z-[3000] flex items-center gap-2 border border-white/10";
            toast.innerHTML = isSaved ? `<i data-lucide="bookmark" class="w-4 h-4 text-yellow-400 fill-yellow-400"></i> Disimpan ke Favorit` : `<i data-lucide="bookmark-minus" class="w-4 h-4"></i> Dihapus dari Favorit`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
            if(typeof lucide !== 'undefined') lucide.createIcons();
        }

        // Polling: Cek otomatis jika data cuaca baru masuk, lalu update widget
        setInterval(() => {
            const widget = document.getElementById('home-weather-widget');
            // Hanya update jika widget ada DAN statusnya masih 'loading' (belum dapat data)
            if (widget && widget.dataset.status === 'loading' && typeof currentWeatherData !== 'undefined' && currentWeatherData) {
                widget.innerHTML = getHomeWidgetContent();
                widget.dataset.status = 'loaded';
                if(typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Update StoryBali Widget
            const storyWidget = document.getElementById('home-storybali-widget');
            if (storyWidget && storyWidget.dataset.status === 'loading' && typeof currentWeatherData !== 'undefined' && currentWeatherData) {
                 storyWidget.innerHTML = getStoryBaliContent();
                 storyWidget.dataset.status = 'loaded';
                 if(typeof lucide !== 'undefined') lucide.createIcons();
            }

            // Update Forecast Widget
            const forecastWidget = document.getElementById('home-forecast-widget');
            if (forecastWidget && forecastWidget.dataset.status === 'loading' && typeof currentWeatherData !== 'undefined' && currentWeatherData) {
                 forecastWidget.innerHTML = getForecastWidgetContent();
                 forecastWidget.dataset.status = 'loaded';
                 if(typeof lucide !== 'undefined') lucide.createIcons();
            }
        }, 2000);
    </script>
</body>
</html>
